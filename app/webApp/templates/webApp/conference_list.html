{% extends "base.html" %}
{% load static %}

{% block head_title %}Conferences{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-calendar-alt mr-2"></i>Conferences</h4>
                </div>
                <div class="card-body">
                    <!-- Filter Bar -->
                    <div class="mb-4">
                        <div class="input-group w-100">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-filter text-muted"></i>
                                </span>
                            </div>
                            <input type="text" 
                                   class="form-control" 
                                   id="filter-input" 
                                   placeholder="Filter conferences by name or year..." 
                                   value="{{ search_query|default:'' }}"
                                   autocomplete="off">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" id="clear-filters" {% if not search_query %}style="display:none;"{% endif %}>
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                        <small class="text-muted mt-1 d-block">
                            <i class="fas fa-info-circle"></i> Filters apply automatically as you type
                        </small>
                    </div>

                    {% if search_query %}
                    <div class="alert alert-info" id="filter-info">
                        <i class="fas fa-filter mr-2"></i>
                        Filtered by "<strong>{{ search_query }}</strong>" 
                        ({{ page_obj.paginator.count }} conference{{ page_obj.paginator.count|pluralize }} found)
                    </div>
                    {% endif %}

                    <!-- Conferences List -->
                    <div id="conferences-container">
                    {% if conferences %}
                    <div class="row">
                        {% for conference in conferences %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <a href="{% url 'conference_detail' conference.id %}" class="conference-card-link">
                                <div class="card conference-card h-100 shadow-sm">
                                    <div class="card-body d-flex flex-column">
                                        {% if conference.logo %}
                                        <!-- Conference with logo: show only logo -->
                                        <div class="text-center mb-3">
                                            <img src="{{ conference.logo.url }}" alt="{{ conference.name }}" class="img-fluid conference-logo-main">
                                        </div>
                                        {% else %}
                                        <!-- Conference without logo: show large placeholder with initials -->
                                        <div class="text-center mb-3">
                                            <div class="conference-logo-placeholder-large mx-auto mb-3">
                                                <span class="conference-initials">{{ conference.name|slice:":2"|upper }}</span>
                                            </div>
                                            <h5 class="card-title mb-1">{{ conference.name }}</h5>
                                            {% if conference.year %}
                                            <div class="text-muted">
                                                <i class="fas fa-calendar mr-1"></i>{{ conference.year }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <div class="mt-auto">
                                            <div>
                                                <span class="badge badge-primary badge-pill px-3 py-2">
                                                    <i class="fas fa-file-pdf mr-1"></i>
                                                    {{ conference.paper_count }} paper{{ conference.paper_count|pluralize }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent border-top">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-clock mr-1"></i>Updated {{ conference.last_update|date:"M d, Y" }}
                                            </small>
                                            <div>
                                                {% if conference.website_url %}
                                                <a href="{{ conference.website_url }}" target="_blank" class="btn btn-sm btn-outline-primary mr-1" onclick="event.stopPropagation()" title="Visit conference website">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                                {% endif %}
                                                {% if user.is_staff or user.is_superuser %}
                                                <button class="btn btn-sm btn-outline-success scrape-btn" 
                                                        data-conference-id="{{ conference.id }}"
                                                        data-conference-name="{{ conference.name }}"
                                                        data-is-scraping="{{ conference.is_scraping|lower }}"
                                                        title="{% if conference.is_scraping %}Scraping in progress{% else %}Start scraping{% endif %}">
                                                    <i class="fas {% if conference.is_scraping %}fa-spinner fa-spin{% else %}fa-play{% endif %}"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    </div>

                    <!-- Pagination -->
                    <div id="pagination-container">
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="Conference pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                        {{ num }}
                                    </a>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    </div>

                    {% else %}
                    <div id="conferences-container">
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">
                            {% if search_query %}
                            No conferences found matching "{{ search_query }}"
                            {% else %}
                            No conferences available
                            {% endif %}
                        </h5>
                    </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scraping Confirmation Modal -->
<div class="modal fade" id="scrapingModal" tabindex="-1" role="dialog" aria-labelledby="scrapingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="scrapingModalLabel">
                    <i class="fas fa-play-circle mr-2"></i>Start Scraping
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to start scraping papers for <strong id="scraping-conference-name"></strong>?</p>
                
                <div class="form-group">
                    <label for="scraping-limit">Number of papers to scrape:</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="scraping-limit" placeholder="Leave empty for all papers" min="1">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="scrape-all-btn" title="Scrape all papers">
                                <i class="fas fa-infinity"></i> All
                            </button>
                        </div>
                    </div>
                    <small class="form-text text-muted">
                        Specify a number to limit papers scraped, or leave empty to scrape all papers.
                    </small>
                </div>
                
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle mr-1"></i>
                    This process may take several minutes depending on the number of papers.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirm-scraping">
                    <i class="fas fa-play mr-1"></i>Start Scraping
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scraping Log Viewer Modal -->
<div class="modal fade" id="logViewerModal" tabindex="-1" role="dialog" aria-labelledby="logViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="logViewerModalLabel">
                    <i class="fas fa-file-alt mr-2"></i>Scraping Log: <span id="log-conference-name"></span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div class="d-flex justify-content-between align-items-center px-3 py-2 bg-light border-bottom">
                    <div>
                        <span class="badge badge-info mr-2" id="log-status-badge">Loading...</span>
                        <small class="text-muted">Papers: <strong id="log-paper-count">-</strong></small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="refresh-log" title="Refresh log">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ml-2" id="stop-scraping" title="Stop scraping">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>
                <div class="log-container">
                    <pre id="log-content" class="mb-0"><code>Loading log...</code></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.log-container {
    height: 500px;
    max-height: 500px;
    min-height: 500px;
    overflow-y: auto;
    overflow-x: auto;
    background-color: #1e1e1e;
    border-radius: 4px;
}

#log-content {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 0;
    padding: 0;
    color: #d4d4d4;
    display: block;
    height: auto;
}

#log-content code {
    display: block;
    padding: 15px;
}

.scrape-btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.conference-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.conference-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
</style>

<script>
$(document).ready(function() {
    let filterTimeout;
    const $filterInput = $('#filter-input');
    const $clearButton = $('#clear-filters');
    const $conferenceContainer = $('#conferences-container');
    const $paginationContainer = $('#pagination-container');
    let currentConferenceId = null;
    let logRefreshInterval = null;
    
    // === Scraping functionality ===
    
    // Handle scrape button click
    $(document).on('click', '.scrape-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const conferenceId = $(this).data('conference-id');
        const conferenceName = $(this).data('conference-name');
        const isScraping = $(this).data('is-scraping');
        
        currentConferenceId = conferenceId;
        
        if (isScraping) {
            // Show log viewer for ongoing scraping
            showLogViewer(conferenceId, conferenceName);
        } else {
            // Show confirmation modal
            $('#scraping-conference-name').text(conferenceName);
            $('#scraping-limit').val(''); // Clear previous limit
            $('#scrapingModal').modal('show');
        }
    });
    
    // Clear limit button
    $('#scrape-all-btn').on('click', function() {
        $('#scraping-limit').val('');
    });
    
    // Confirm scraping start
    $('#confirm-scraping').on('click', function() {
        const $btn = $(this);
        const originalHtml = $btn.html();
        const limit = $('#scraping-limit').val();
        
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Starting...');
        
        const requestData = {};
        if (limit && limit > 0) {
            requestData.limit = parseInt(limit);
        }
        
        $.ajax({
            url: `/conference/${currentConferenceId}/scrape/start/`,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    $('#scrapingModal').modal('hide');
                    
                    // Show log viewer
                    const conferenceName = $('#scraping-conference-name').text();
                    showLogViewer(currentConferenceId, conferenceName);
                    
                    // Update button state
                    const $scrapeBtn = $(`.scrape-btn[data-conference-id="${currentConferenceId}"]`);
                    $scrapeBtn.data('is-scraping', true)
                              .attr('title', 'Scraping in progress')
                              .html('<i class="fas fa-spinner fa-spin"></i>');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || 'Failed to start scraping';
                alert('Error: ' + message);
            },
            complete: function() {
                $btn.prop('disabled', false).html(originalHtml);
            }
        });
    });
    
    // Show log viewer modal
    function showLogViewer(conferenceId, conferenceName) {
        currentConferenceId = conferenceId;
        $('#log-conference-name').text(conferenceName);
        $('#logViewerModal').modal('show');
        
        // Start refreshing log
        refreshLog();
        startLogRefresh();
    }
    
    // Refresh log content
    function refreshLog() {
        if (!currentConferenceId) return;
        
        $.ajax({
            url: `/conference/${currentConferenceId}/scrape/log/`,
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    const content = response.content || 'No log content available yet.';
                    $('#log-content').text(content);
                    
                    // Scroll to bottom
                    const logContainer = $('.log-container')[0];
                    if (logContainer) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                } else {
                    $('#log-content').text(response.message || 'Error loading log file.');
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || 'Error loading log file.';
                $('#log-content').text(message);
            }
        });
        
        // Update status
        updateScrapingStatus();
    }
    
    // Update scraping status
    function updateScrapingStatus() {
        if (!currentConferenceId) return;
        
        $.ajax({
            url: `/conference/${currentConferenceId}/scrape/status/`,
            type: 'GET',
            success: function(data) {
                const isScraping = data.is_scraping;
                const status = data.last_scrape_status || 'unknown';
                const paperCount = data.paper_count || 0;
                
                // Update badge
                let badgeClass = 'badge-secondary';
                let badgeText = 'Unknown';
                let badgeIcon = '';
                
                if (isScraping) {
                    badgeClass = 'badge-info';
                    badgeText = 'Running';
                    badgeIcon = '<i class="fas fa-spinner fa-spin mr-1"></i>';
                } else if (status === 'success') {
                    badgeClass = 'badge-success';
                    badgeText = 'Completed';
                    badgeIcon = '<i class="fas fa-check mr-1"></i>';
                } else if (status === 'failed') {
                    badgeClass = 'badge-danger';
                    badgeText = 'Failed';
                    badgeIcon = '<i class="fas fa-times mr-1"></i>';
                } else if (status === 'cancelled') {
                    badgeClass = 'badge-warning';
                    badgeText = 'Cancelled';
                    badgeIcon = '<i class="fas fa-ban mr-1"></i>';
                }
                
                $('#log-status-badge').removeClass().addClass(`badge ${badgeClass}`).html(badgeIcon + badgeText);
                $('#log-paper-count').text(paperCount);
                
                // Enable/disable stop button
                $('#stop-scraping').prop('disabled', !isScraping);
                
                // Stop refreshing if not scraping
                if (!isScraping) {
                    stopLogRefresh();
                }
            }
        });
    }
    
    // Start auto-refresh
    function startLogRefresh() {
        stopLogRefresh(); // Clear any existing interval
        logRefreshInterval = setInterval(refreshLog, 2000); // Refresh every 2 seconds
    }
    
    // Stop auto-refresh
    function stopLogRefresh() {
        if (logRefreshInterval) {
            clearInterval(logRefreshInterval);
            logRefreshInterval = null;
        }
    }
    
    // Manual refresh button
    $('#refresh-log').on('click', function() {
        const $icon = $(this).find('i');
        $icon.addClass('fa-spin');
        refreshLog();
        setTimeout(() => $icon.removeClass('fa-spin'), 1000);
    });
    
    // Stop scraping button
    $('#stop-scraping').on('click', function() {
        if (!currentConferenceId) return;
        
        if (!confirm('Are you sure you want to stop the scraping process?')) {
            return;
        }
        
        const $btn = $(this);
        const originalHtml = $btn.html();
        
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Stopping...');
        
        $.ajax({
            url: `/conference/${currentConferenceId}/scrape/stop/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    alert('Scraping stopped successfully.');
                    refreshLog();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Failed to stop scraping.');
            },
            complete: function() {
                $btn.prop('disabled', false).html(originalHtml);
            }
        });
    });
    
    // Clean up when modal is closed
    $('#logViewerModal').on('hidden.bs.modal', function() {
        stopLogRefresh();
        currentConferenceId = null;
        
        // Refresh conference list to update button states
        location.reload();
    });
    
    // === Filter functionality (existing) ===
    
    // Auto-filter on input with debouncing
    $filterInput.on('input', function() {
        clearTimeout(filterTimeout);
        const query = $(this).val().trim();
        
        // Show/hide clear button
        if (query.length > 0) {
            $clearButton.show();
        } else {
            $clearButton.hide();
        }
        
        // Debounce: wait 400ms after user stops typing
        filterTimeout = setTimeout(function() {
            applyFilter(query);
        }, 400);
    });
    
    // Clear filters button
    $clearButton.on('click', function() {
        $filterInput.val('');
        $(this).hide();
        applyFilter('');
    });
    
    // Apply filter via AJAX
    function applyFilter(query) {
        const url = '{% url "conference_list" %}';
        
        $.ajax({
            url: url,
            data: { q: query },
            type: 'GET',
            beforeSend: function() {
                $conferenceContainer.css('opacity', '0.5');
            },
            success: function(response) {
                const $response = $(response);
                const $newContainer = $response.find('#conferences-container');
                const $newPagination = $response.find('#pagination-container');
                const $newFilterInfo = $response.find('#filter-info');
                
                // Update containers
                $conferenceContainer.html($newContainer.html());
                $paginationContainer.html($newPagination.html());
                
                // Update filter info
                if ($newFilterInfo.length) {
                    if ($('#filter-info').length) {
                        $('#filter-info').replaceWith($newFilterInfo);
                    } else {
                        $conferenceContainer.before($newFilterInfo);
                    }
                } else {
                    $('#filter-info').remove();
                }
                
                $conferenceContainer.css('opacity', '1');
                
                // Update URL without page reload
                const newUrl = query ? `${url}?q=${encodeURIComponent(query)}` : url;
                window.history.pushState({}, '', newUrl);
            },
            error: function() {
                $conferenceContainer.css('opacity', '1');
                alert('Error applying filter. Please try again.');
            }
        });
    }
    
    // Handle pagination clicks
    $(document).on('click', '#pagination-container .page-link', function(e) {
        e.preventDefault();
        const url = $(this).attr('href');
        
        $.ajax({
            url: url,
            type: 'GET',
            beforeSend: function() {
                $conferenceContainer.css('opacity', '0.5');
            },
            success: function(response) {
                const $response = $(response);
                const $newContainer = $response.find('#conferences-container');
                const $newPagination = $response.find('#pagination-container');
                
                $conferenceContainer.html($newContainer.html());
                $paginationContainer.html($newPagination.html());
                $conferenceContainer.css('opacity', '1');
                
                // Update URL
                window.history.pushState({}, '', url);
                
                // Scroll to top of list
                $('html, body').animate({
                    scrollTop: $('#conferences-container').offset().top - 100
                }, 300);
            },
            error: function() {
                $conferenceContainer.css('opacity', '1');
            }
        });
    });
});
</script>
{% endblock %}
