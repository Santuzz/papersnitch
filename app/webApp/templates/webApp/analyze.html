{% extends "base.html" %}
{% load static %}

{% block head_title %}Analyze Paper{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow" style="position: relative;">
                {% if not user.is_authenticated %}
                <!-- Login Required Overlay -->
                <div id="login-overlay">
                    <div class="text-center p-5">
                        <i class="fas fa-lock fa-4x text-primary mb-4"></i>
                        <h3 class="mb-3">Login Required</h3>
                        <p class="text-muted mb-4">You need to be logged in to analyze a paper.<br>Please login or create an account to continue.</p>
                        <div class="d-flex justify-content-center gap-3">
                            <a href="{% url 'login' %}" class="btn btn-primary btn-lg mr-2">
                                <i class="fas fa-sign-in-alt mr-2"></i>Login
                            </a>
                            <a href="{% url 'signup' %}" class="btn btn-outline-primary btn-lg">
                                <i class="fas fa-user-plus mr-2"></i>Sign Up
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-file-pdf mr-2"></i>Paper Analysis</h4>
                </div>
                <div class="card-body">
                    <!-- Upload Form -->
                    <div id="upload-section">
                        <form id="check-past-form" enctype="multipart/form-data" autocomplete="off">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="pdf-file" class="font-weight-bold">Upload PDF Paper</label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="pdf-file" name="pdf_file" accept=".pdf" required autocomplete="off">
                                    <label class="custom-file-label" for="pdf-file">Choose PDF file...</label>
                                </div>
                                <small class="form-text text-muted">Upload a scientific paper in PDF format for analysis.</small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg btn-block" id="check-past-btn" disabled>
                                <i class="fas fa-history mr-2"></i>Check for Past Analyses
                            </button>
                        </form>
                        
                        <!-- Past Analyses Section Success(Hidden initially) -->
                        <div id="past-analyses-section" style="display: none;">
                            <hr>
                            <h5 class="mb-3"><i class="fas fa-database mr-2"></i>Search Result</h5>
                            <div class="alert alert-info">
                                <strong>Paper Title:</strong> <span id="paper-title"></span>
                            </div>
                            <div id="past-analyses-list" class="mb-4">
                                <!-- Past analyses will be listed here -->
                            </div>
                        </div>

                         <!-- Past Analyses Section Failure (Hidden initially) -->
                        <div id="past-analyses-section-fail" style="display: none;">
                            <hr>
                            <h5 class="mb-3"><i class="fas fa-database mr-2"></i>Search Result</h5>
                            <div class="alert alert-danger">
                                <strong>No paper found with title: </strong> <span id="paper-title-fail"></span>
                                <br/>
                                <strong>Proceed to analyze this paper</strong>
                            </div>
                        </div>
                        
                        <!-- Model Selection Form (Hidden initially) -->
                        <div id="model-selection-section" style="display: none;">
                            <hr>
                            <form id="analyze-form" enctype="multipart/form-data" autocomplete="off">
                                {% csrf_token %}
                                <input type="hidden" id="uploaded-pdf-file" name="pdf_file">
                                
                                <div class="form-group">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="font-weight-bold mb-0">Select Models for Analysis</label>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-models-btn">
                                            <i class="fas fa-lg fa-check mr-1"></i>Select All
                                        </button>
                                    </div>
                                    <div class="model-checkboxes">
                                        {% for model_key, visual_name in available_models.items %}
                                        <div class="custom-control custom-checkbox custom-control-inline">
                                            <input type="checkbox" class="custom-control-input model-checkbox" id="model-{{ model_key }}" name="models" value="{{ model_key }}">
                                            <label class="custom-control-label" for="model-{{ model_key }}">{{ visual_name }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <small class="form-text text-muted">Select at least one model to analyze the paper.</small>
                                </div>
                                
                                <button type="submit" class="btn btn-primary btn-lg btn-block" id="analyze-btn" disabled>
                                    <i class="fas fa-search mr-2"></i>Analyze
                                </button>
                            </form>
                        </div>

                        
                    </div>

                    <!-- Progress Section (Hidden initially) -->
                    <div id="progress-section" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-terminal mr-2"></i>Analysis in Progress</h5>
                        <div class="terminal-output" id="terminal-log">
                            <!-- Log lines will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Results Section (Hidden initially) -->
                    <div id="results-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0"><i class="fas fa-check-circle text-success mr-2"></i>Analysis Complete</h5>
                            <button class="btn btn-outline-primary" id="new-analysis-btn">
                                <i class="fas fa-plus mr-2"></i>New Analysis
                            </button>
                        </div>
                        
                        <!-- Model Tabs -->
                        <ul class="nav nav-tabs" id="model-tabs" role="tablist">
                            <!-- Tabs will be dynamically inserted here -->
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content border border-top-0 p-3" id="model-tab-content">
                            <!-- Content will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- Error Section (Hidden initially) -->
                    <div id="error-section" style="display: none;">
                        <div class="alert alert-danger" role="alert">
                            <h5><i class="fas fa-exclamation-triangle mr-2"></i>Error</h5>
                            <p id="error-message"></p>
                            <button class="btn btn-outline-danger" id="retry-btn">
                                <i class="fas fa-redo mr-2"></i>Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Detail Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1" role="dialog" aria-labelledby="analysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="analysisModalLabel">Analysis Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="analysis-modal-content">
                <div class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading analysis...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>

document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('upload-form');
    const uploadSection = document.getElementById('upload-section');
    const progressSection = document.getElementById('progress-section');
    const resultsSection = document.getElementById('results-section');
    const errorSection = document.getElementById('error-section');
    const terminalLog = document.getElementById('terminal-log');
    const errorMessage = document.getElementById('error-message');
    const analyzeBtn = document.getElementById('analyze-btn');
    const newAnalysisBtn = document.getElementById('new-analysis-btn');
    const retryBtn = document.getElementById('retry-btn');
    
    let currentTaskId = null;
    let pollInterval = null;
    let lastStep = '';
    let startTime = null;
    let title = null;

    
    // Function to add a log line to the terminal
    function addLogLine(message, type = 'info') {
    // 1. Rimuove lo spinner da tutte le righe precedenti
    const activeSpinners = terminalLog.querySelectorAll('.fa-spinner');
    activeSpinners.forEach(s => s.remove());

    const line = document.createElement('div');
    line.className = 'terminal-line';
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
    
    let icon = '';
    let textClass = 'terminal-info';
    
    switch(type) {
        case 'success':
            icon = '✓';
            textClass = 'terminal-success';
            break;
        case 'error':
            icon = '✗';
            textClass = 'terminal-error';
            break;
        case 'warning':
            icon = '⚠';
            textClass = 'terminal-warning';
            break;
        case 'spinner':
            icon = '●';
            textClass = 'terminal-info';
            break;
        default:
            icon = '→';
            textClass = 'terminal-info';
    }
    
    // 2. Aggiungiamo lo spinner solo se il tipo è 'spinner'
    // Lo mettiamo alla fine del messaggio per pulizia visiva
    const spinnerHtml = (type === 'spinner') ? ' <i class="fas fa-spinner fa-spin ml-2"></i>' : '';
    
    line.innerHTML = `<span class="terminal-time">[${timeStr}]</span> <span class="terminal-prompt">${icon}</span> <span class="${textClass}">${spinnerHtml} ${message}</span>`;
    
    terminalLog.appendChild(line);
    terminalLog.scrollTop = terminalLog.scrollHeight;
}
    
    // Clear file input on page load to prevent browser restore
    const pdfFileInput = document.getElementById('pdf-file');
    const modelCheckboxes = document.querySelectorAll('.model-checkbox');
    const checkPastBtn = document.getElementById('check-past-btn');
    const checkPastForm = document.getElementById('check-past-form');
    const analyzeForm = document.getElementById('analyze-form');
    const pastAnalysesSection = document.getElementById('past-analyses-section');
    const pastAnalysesSectionFail = document.getElementById('past-analyses-section-fail');
    const modelSelectionSection = document.getElementById('model-selection-section');
    const pastAnalysesList = document.getElementById('past-analyses-list');
    const paperTitleSpan = document.getElementById('paper-title');
    const paperTitleSpanFail = document.getElementById('paper-title-fail');
    
    pdfFileInput.value = '';
    document.querySelector('.custom-file-label').textContent = 'Choose PDF file...';
    checkPastBtn.disabled = true;
    analyzeBtn.disabled = true;
    
    let uploadedPdfFile = null;
    
    // Function to check if check-past button should be enabled
    function updateCheckPastButton() {
        const hasFile = pdfFileInput.files && pdfFileInput.files[0];
        checkPastBtn.style.display = 'block';
        checkPastBtn.disabled = !hasFile;
    }
    
    // Function to check if analyze button should be enabled
    function updateAnalyzeButton() {
        const hasModel = document.querySelectorAll('.model-checkbox:checked').length > 0;
        analyzeBtn.disabled = !hasModel;
    }
    
    // File input label update
    pdfFileInput.addEventListener('change', function(e) {
        const fileName = e.target.files[0] ? e.target.files[0].name : 'Choose PDF file...';
        document.querySelector('.custom-file-label').textContent = fileName;
        uploadedPdfFile = e.target.files[0];
        updateCheckPastButton();
        // Hide past analyses and model selection when new file is selected
        pastAnalysesSection.style.display = 'none';
        pastAnalysesSectionFail.style.display = 'none';
        modelSelectionSection.style.display = 'none';
        //TODO: Reset check past button state
        checkPastBtn.innerHTML = '<i class="fas fa-history mr-2"></i>Check for Past Analyses';
    });
    
    // Check past analyses form submission
    checkPastForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(checkPastForm);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        checkPastBtn.disabled = true;
        checkPastBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
        
        try {
            const response = await fetch('{% url "check_past_analyses" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (!response.ok) {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    alert('Error: ' + (errorData.error || 'Failed to check past analyses'));
                } else {
                    alert('Error: Failed to check past analyses');
                }
                checkPastBtn.disabled = false;
                checkPastBtn.style.display = 'block';
                checkPastBtn.innerHTML = '<i class="fas fa-history mr-2"></i>Check for Past Analyses';
                return;
            }

            const data = await response.json();
            
            // Show model selection section
            modelSelectionSection.style.display = 'block';
            title = data.title;
            if (data.has_past_analyses) {
                // Show past analyses
                paperTitleSpan.textContent = data.title;
                pastAnalysesSection.style.display = 'block';
                pastAnalysesSectionFail.style.display = 'none';
                renderPastAnalyses(data.past_analyses);
            } else {
                // No past analyses, just show model selection
                pastAnalysesSection.style.display = 'none';
                paperTitleSpanFail.textContent = data.title;
                pastAnalysesSectionFail.style.display = 'block';
            }
            
            checkPastBtn.disabled = true;
            checkPastBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Checked';
            checkPastBtn.style.display = 'none';
        } catch (error) {
            alert('Network error: ' + error.message);
            checkPastBtn.disabled = false;
            checkPastBtn.innerHTML = '<i class="fas fa-history mr-2"></i>Check for Past Analyses';
        }
    });
    
    // Render past analyses
    function renderPastAnalyses(analyses) {
        pastAnalysesList.innerHTML = '';
        
        const table = document.createElement('table');
        table.className = 'table table-striped table-hover';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Date</th>
                    <th>User</th>
                    <th>Duration</th>
                    <th>Tokens</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        `;
        
        const tbody = table.querySelector('tbody');
        analyses.forEach(function(analysis) {
            const row = document.createElement('tr');
            const statusBadge = analysis.has_error 
                ? '<span class="badge badge-danger">Error</span>' 
                : '<span class="badge badge-success">Success</span>';
            const duration = analysis.duration ? `${analysis.duration.toFixed(2)}s` : 'N/A';
            const tokens = (analysis.input_tokens && analysis.output_tokens) 
                ? `${analysis.input_tokens + analysis.output_tokens}` 
                : 'N/A';
            
            row.innerHTML = `
                <td>${analysis.model_name}</td>
                <td>${analysis.created_at}</td>
                <td>${analysis.user}</td>
                <td>${duration}</td>
                <td>${tokens}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-analysis-btn" 
                            data-analysis-id="${analysis.id}"
                            data-toggle="modal" 
                            data-target="#analysisModal">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        pastAnalysesList.appendChild(table);
        
        // Attach event listeners to view buttons
        document.querySelectorAll('.view-analysis-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const analysisId = this.dataset.analysisId;
                loadAnalysisDetails(analysisId);
            });
        });
    }
    
    // Load analysis details function
    // TODO moved to script.js
    
    // Model checkbox change handler
    modelCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateAnalyzeButton);
    });
    
    // Select All / Deselect All button handler
    const selectAllBtn = document.getElementById('select-all-models-btn');
    selectAllBtn.addEventListener('click', function() {
        const allChecked = Array.from(modelCheckboxes).every(cb => cb.checked);
        modelCheckboxes.forEach(function(checkbox) {
            checkbox.checked = !allChecked;
        });
        // Update button text
        if (allChecked) {
            selectAllBtn.innerHTML = '<i class="fas fa-lg fa-check mr-1"></i>Select All';
        } else {
            selectAllBtn.innerHTML = '<i class="fas fa-lg fa-times mr-1"></i>Deselect All';
        }
        updateAnalyzeButton();
    });
    
    // Update Select All button text when individual checkboxes change
    function updateSelectAllButton() {
        const allChecked = Array.from(modelCheckboxes).every(cb => cb.checked);
        if (allChecked && modelCheckboxes.length > 0) {
            selectAllBtn.innerHTML = '<i class="fas fa-lg fa-times mr-1"></i>Deselect All';
        } else {
            selectAllBtn.innerHTML = '<i class="fas fa-lg fa-check mr-1"></i>Select All';
        }
    }
    
    modelCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateSelectAllButton);
    });
    
    // Upload form submission
    analyzeForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Create a new FormData with the uploaded PDF file
        const formData = new FormData();
        // formData.append('pdf_file', uploadedPdfFile);

        // Add title if available
        if (title) {
            formData.append('title', title);
        }
        
        // Add selected models
        const selectedModels = document.querySelectorAll('.model-checkbox:checked');
        selectedModels.forEach(function(checkbox) {
            formData.append('models', checkbox.value);
        });
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        
        try {
            const response = await fetch('{% url "analyze" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            // Handle non-OK responses before trying to parse JSON
            if (!response.ok) {
                if (response.status === 413) {
                    showError('File too large. Maximum size is 50MB.');
                    return;
                }
                // Try to get error message from response
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    showError(errorData.error || `Upload failed (${response.status})`);
                } else {
                    showError(`Upload failed with status ${response.status}`);
                }
                return;
            }

            const data = await response.json();
            
            currentTaskId = data.task_id;
            showProgress();
            startPolling();
        } catch (error) {
            showError('Network error: ' + error.message);
        }
    });
    
    // New analysis button
    newAnalysisBtn.addEventListener('click', function() {
        resetForm();
    });
    
    // Retry button
    retryBtn.addEventListener('click', function() {
        resetForm();
    });
    
        function showProgress() {
            uploadSection.style.display = 'none';
            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            errorSection.style.display = 'none';
            // Clear terminal and add initial message
            terminalLog.innerHTML = '';
            lastStep = '';
            addLogLine('Initializing analysis...', 'spinner');
        }
    
        function showResults(results) {
        // Add success message to terminal before transitioning
        addLogLine('Analysis completed successfully!', 'success');
        setTimeout(function() {
            uploadSection.style.display = 'none';
            progressSection.style.display = 'none';
            resultsSection.style.display = 'block';
            errorSection.style.display = 'none';
            renderResults(results);
        }, 1000);
    }
    
    function showError(message) {
        // Add error message to terminal before transitioning
        addLogLine('Error: ' + message, 'error');
        setTimeout(function() {
            uploadSection.style.display = 'none';
            progressSection.style.display = 'none';
            resultsSection.style.display = 'none';
            errorSection.style.display = 'block';
            errorMessage.textContent = message;
        }, 500);
    }
    
    function resetForm() {
        uploadSection.style.display = 'block';
        progressSection.style.display = 'none';
        resultsSection.style.display = 'none';
        errorSection.style.display = 'none';
        pastAnalysesSection.style.display = 'none';
        pastAnalysesSectionFail.style.display = 'none';
        modelSelectionSection.style.display = 'none';

        
        checkPastForm.reset();
        analyzeForm.reset();
        document.querySelector('.custom-file-label').textContent = 'Choose PDF file...';
        
        // Uncheck all model checkboxes
        modelCheckboxes.forEach(function(checkbox) {
            checkbox.checked = false;
        });
        
        checkPastBtn.disabled = true;
        checkPastBtn.style.display = 'block';
        checkPastBtn.innerHTML = '<i class="fas fa-history mr-2"></i>Check for Past Analyses';
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Analyze';
        
        // Reset terminal
        terminalLog.innerHTML = '';
        lastStep = '';
        currentTaskId = null;
        uploadedPdfFile = null;
    }
    
    function updateProgress(progress, status) {
        // Only add new log line if status changed
        if (status && status !== lastStep) {
            addLogLine(status, 'spinner');
            lastStep = status;
        }
    }
    
    function startPolling() {
        pollInterval = setInterval(async function() {
            if (!currentTaskId) {
                clearInterval(pollInterval);
                return;
            }
            
            try {
                const response = await fetch(`/analyze/status/${currentTaskId}/`);
                const data = await response.json();
                
                if (data.error && response.status === 404) {
                    clearInterval(pollInterval);
                    showError('Task not found!');
                    return;
                }
                
                updateProgress(data.progress, data.current_step);
                
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    showResults(data.results);
                } 
                else if (data.status === 'error') {
                    clearInterval(pollInterval);
                    showError(data.error || 'Analysis failed');
                }
            } catch (error) {
                clearInterval(pollInterval);
                showError('Connection error: ' + error.message);
            } 
        }, 1000);
    }
    
    function renderResults(results) {
        const tabsContainer = document.getElementById('model-tabs');
        const contentContainer = document.getElementById('model-tab-content');
        
        tabsContainer.innerHTML = '';
        contentContainer.innerHTML = '';
        
        let isFirst = true;
        
        for (const [modelKey, modelData] of Object.entries(results)) {
            // Create tab
            const tabLi = document.createElement('li');
            tabLi.className = 'nav-item';
            tabLi.innerHTML = `
                <a class="nav-link ${isFirst ? 'active' : ''}" 
                   id="${modelKey}-tab" 
                   data-toggle="tab" 
                   href="#${modelKey}-content" 
                   role="tab">
                    ${modelData.model}
                    ${modelData.error ? '<i class="fas fa-exclamation-circle text-danger ml-1"></i>' : ''}
                </a>
            `;
            tabsContainer.appendChild(tabLi);
            
            // Create tab content
            const tabContent = document.createElement('div');
            tabContent.className = `tab-pane fade ${isFirst ? 'show active' : ''}`;
            tabContent.id = `${modelKey}-content`;
            tabContent.setAttribute('role', 'tabpanel');
            
            if (modelData.error) {
                tabContent.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${modelData.error}
                    </div>
                `;
            } else {
                tabContent.innerHTML = renderAnalysisDetails(modelData, false);
            }
            
            contentContainer.appendChild(tabContent);
            
            isFirst = false;
        }
    }
    
    {% comment %} function renderModelResultOld(data) {
        const result = data.result;
        const uniqueId = Math.random().toString(36).substr(2, 9);
        
        let html = `
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="text-muted small">
                        <i class="fas fa-clock mr-1"></i>Duration: ${data.duration}s | 
                        <i class="fas fa-arrow-down mr-1"></i>Input: ${data.input_tokens} tokens | 
                        <i class="fas fa-arrow-up mr-1"></i>Output: ${data.output_tokens} tokens
                </div>
                <div class="text-right">
                    <div class="h4 mb-0 text-primary font-weight-bold">
                        ${data.final_score !== undefined ? data.final_score : 'N/A'}
                    </div>
                    <small class="text-muted">Final Score</small>
                </div>
            </div>
        `;
        
        // Datasets section
        html += `
            <div class="card criterion-card">
                <div class="card-header bg-light collapsible" data-toggle="collapse" data-target="#datasets-${uniqueId}" aria-expanded="true">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-database mr-2"></i>Datasets</h6>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div id="datasets-${uniqueId}" class="collapse show">
                    <div class="card-body">
                        ${result.datasets && result.datasets.extracted && result.datasets.extracted.length > 0
                            ? `<ul class="dataset-list mb-0">${result.datasets.extracted.map(d => `<li>${d}</li>`).join('')}</ul>`
                            : '<p class="text-muted mb-0">No datasets identified</p>'}
                    </div>
                </div>
            </div>
        `;
        
        // Scored sections
        const scoredSections = [
            { key: 'code', icon: 'fa-code', title: 'Code Repository' },
            { key: 'annotation', icon: 'fa-tags', title: 'Annotation' },
            { key: 'preprocessing', icon: 'fa-cogs', title: 'Preprocessing' },
            { key: 'evaluation', icon: 'fa-chart-bar', title: 'Evaluation' },
            { key: 'licensing', icon: 'fa-balance-scale', title: 'Licensing' }
        ];
        
        for (const section of scoredSections) {
            const data = result[section.key];
            const score = data && typeof data.score === 'number' ? data.score : 0;
            const collapseId = `${section.key}-${uniqueId}`;
            
            console.log(JSON.stringify(data));

            html += `
                <div class="card criterion-card">
                    <div class="card-header bg-light collapsible" data-toggle="collapse" data-target="#${collapseId}" aria-expanded="true">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas ${section.icon} mr-2"></i>${section.title}
                            ${section.key === 'code' && data.url !== ''
                                ? `<a href="${data.url}" target="_blank"
                                    class="btn btn-sm btn-outline-secondary ml-2">
                                    <i class="fas fa-external-link-alt mr-1"></i>
                                    View Repository
                                    </a>`
                                : ''}</h6>
                            <div class="d-flex align-items-center">
                                ${score === -1 
                                    ? `<span class="score-badge score-${score} mr-2">n/a</span>` 
                                    : `<span class="score-badge score-${score} mr-2">${score}</span>`}
                                <i class="fas fa-chevron-down toggle-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div id="${collapseId}" class="collapse show">
                        <div class="card-body">
                            ${data && data.extracted 
                                ? `
                                    <h6 class="text-muted">Extracted Information:</h6>
                                    <div class="extracted-text">${data.extracted}</div>
                                    ${data.score_explanation 
                                        ? `<h6 class="text-muted mt-3">Score Explanation:</h6><p class="mb-0">${data.score_explanation}</p>`
                                        : ''}
                                  `
                                : '<p class="text-muted mb-0">No information extracted for this criterion</p>'}
                        </div>
                    </div>
                </div>
            `;
        } 
        
        return html;
    }{% endcomment %}
});
</script>
{% endblock %}
