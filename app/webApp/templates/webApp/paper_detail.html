{% extends "base.html" %}
{% load static %}

{% block head_title %}{{ paper.title }} - Details{% endblock %}

{% block extra_head %}
<!-- Mermaid.js for DAG visualization -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
    .workflow-diagram-container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 30px;
        min-height: 500px;
    }
    
    .mermaid-diagram {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 450px;
        width: 100%;
    }
    
    .mermaid-diagram .mermaid {
        width: 100%;
        min-height: 450px;
    }
    
    .mermaid-diagram svg {
        max-width: 100%;
        height: auto;
        min-height: 450px;
    }
    
    /* Mermaid node styling overrides */
    .mermaid .node rect,
    .mermaid .node circle {
        stroke-width: 3px;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        transition: all 0.3s ease;
    }
    
    .mermaid .node:hover rect,
    .mermaid .node:hover circle {
        filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.15));
        transform: translateY(-2px);
    }
    
    .mermaid .node.completed rect {
        fill: url(#gradient-completed) !important;
        stroke: #0a7a6e !important;
    }
    
    .mermaid .node.running rect {
        fill: url(#gradient-running) !important;
        stroke: #2471a3 !important;
        animation: pulse-running 1.5s ease-in-out infinite, glow-running 2s ease-in-out infinite;
    }
    
    .mermaid .node.failed rect {
        fill: url(#gradient-failed) !important;
        stroke: #a93226 !important;
    }
    
    .mermaid .node.pending rect {
        fill: url(#gradient-pending) !important;
        stroke: #d4ac0d !important;
    }
    
    /* Node text styling */
    .mermaid .nodeLabel {
        color: white !important;
        font-weight: 600 !important;
        font-size: 17px !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    /* Edge styling */
    .mermaid .edgePath path {
        stroke: #5d6d7e !important;
        stroke-width: 2.5px !important;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.1));
    }
    
    .mermaid .arrowheadPath {
        fill: #5d6d7e !important;
        stroke: #5d6d7e !important;
    }
    
    .mermaid .edgeLabel {
        background-color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Animations for running nodes */
    @keyframes pulse-running {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.85;
        }
    }
    
    @keyframes glow-running {
        0%, 100% {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)) drop-shadow(0 0 0 rgba(52, 152, 219, 0));
        }
        50% {
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.15)) drop-shadow(0 0 20px rgba(52, 152, 219, 0.6));
        }
    }
    
    .clickable-node {
        cursor: pointer;
    }
    
    /* Hide edge labels completely - not needed for this workflow visualization */
    .mermaid g.edgeLabels,
    .mermaid .edgeLabels {
        display: none !important;
    }
    
    /* Style arrowheads properly */
    .mermaid marker path {
        fill: #5d6d7e !important;
    }
    
    /* Add SVG gradients for nodes */
    .mermaid svg defs {
        display: block;
    }
    
    .node-legend {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .legend-items {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .legend-help {
        white-space: nowrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
        color: #34495e;
    }
    
    .legend-item i {
        font-size: 16px;
    }
    
    .legend-box {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 2px solid;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .legend-box.completed {
        background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
        border-color: #0a7a6e;
    }
    
    .legend-box.running {
        background: linear-gradient(135deg, #2874a6 0%, #3498db 100%);
        border-color: #2471a3;
        animation: pulse-running 2s ease-in-out infinite;
    }
    
    .legend-box.failed {
        background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        border-color: #a93226;
    }
    
    .legend-box.pending {
        background: linear-gradient(135deg, #d4ac0d 0%, #f4d03f 100%);
        border-color: #d4ac0d;
    }
    
    .status-badge-large {
        font-size: 0.7rem;
        padding: 2px 6px;
        position: absolute;
        top: 2px;
        right: 2px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <!-- Paper Header -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h4 class="mb-2">
                                <i class="fas fa-file-pdf mr-2"></i>{{ paper.title }}
                            </h4>
                            <div class="small">
                                {% if paper.conference %}
                                <span class="mr-3">
                                    <i class="fas fa-building mr-1"></i>
                                    <a href="{% url 'conference_detail' paper.conference.id %}" class="text-white">
                                        {{ paper.conference.name }}{% if paper.conference.year %} {{ paper.conference.year }}{% endif %}
                                    </a>
                                </span>
                                {% endif %}
                                {% if paper.doi %}
                                <span class="mr-3"><i class="fas fa-fingerprint mr-1"></i>{{ paper.doi }}</span>
                                {% endif %}
                                {% if paper.authors %}
                                <span><i class="fas fa-users mr-1"></i>{{ paper.authors|truncatewords:5 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            {% if paper.conference %}
                            <a href="{% url 'conference_detail' paper.conference.id %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left mr-1"></i> Back
                            </a>
                            {% else %}
                            <a href="{% url 'conference_list' %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left mr-1"></i> Conferences
                            </a>
                            {% endif %}
                            {% if paper.file %}
                            <a href="{{ paper.file.url }}" target="_blank" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-download mr-1"></i> Download PDF
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Workflow Diagram -->
            {% if latest_workflow %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram mr-2"></i>Latest Workflow Analysis
                        </h5>
                        <div>
                            <span class="badge badge-{{ latest_workflow.status|lower }}">
                                {% if latest_workflow.status == 'completed' %}
                                <i class="fas fa-check-circle"></i> Completed
                                {% elif latest_workflow.status == 'running' %}
                                <i class="fas fa-spinner fa-spin"></i> Running
                                {% elif latest_workflow.status == 'failed' %}
                                <i class="fas fa-times-circle"></i> Failed
                                {% elif latest_workflow.status == 'pending' %}
                                <i class="fas fa-clock"></i> Pending
                                {% else %}
                                {{ latest_workflow.status|title }}
                                {% endif %}
                            </span>
                            <small class="text-muted ml-2">
                                Run #{{ latest_workflow.run_number }} • 
                                {{ latest_workflow.created_at|date:"M d, Y H:i" }}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body workflow-diagram-container mb-0">
                    <!-- Mermaid DAG Diagram -->
                    <div class="mermaid-diagram" id="workflow-mermaid">
                        <!-- Mermaid syntax will be inserted here -->
                    </div>
                    
                    <div class="node-legend">
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-box completed"></div>
                                <span><i class="fas fa-check-circle text-success"></i> Completed</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box running"></div>
                                <span><i class="fas fa-spinner text-info"></i> Running</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box failed"></div>
                                <span><i class="fas fa-times-circle text-danger"></i> Failed</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box pending"></div>
                                <span><i class="fas fa-clock text-warning"></i> Pending</span>
                            </div>
                        </div>
                        <div class="legend-help text-muted small">
                            <i class="fas fa-info-circle mr-1"></i> Click on any node to view execution details and logs
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Other Workflow Runs -->
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-history mr-2"></i>Workflow Run History
                        <span class="badge badge-secondary ml-2">{{ workflow_runs.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if workflow_runs %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Run #</th>
                                    <th>Workflow</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Started</th>
                                    <th>Duration</th>
                                    <th>Created By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for run in workflow_runs %}
                                <tr class="{% if run.id == latest_workflow.id %}table-active{% endif %}">
                                    <td>
                                        <strong>#{{ run.run_number }}</strong>
                                        {% if run.id == latest_workflow.id %}
                                        <span class="badge badge-info ml-1">Latest</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ run.workflow_definition.name }}
                                            <span class="text-muted">(v{{ run.workflow_definition.version }})</span>
                                        </small>
                                    </td>
                                    <td>
                                        {% if run.status == 'completed' %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> Completed
                                        </span>
                                        {% elif run.status == 'running' %}
                                        <span class="badge badge-info">
                                            <i class="fas fa-spinner fa-spin"></i> Running
                                        </span>
                                        {% elif run.status == 'failed' %}
                                        <span class="badge badge-danger">
                                            <i class="fas fa-times-circle"></i> Failed
                                        </span>
                                        {% elif run.status == 'pending' %}
                                        <span class="badge badge-warning">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                        {% else %}
                                        <span class="badge badge-secondary">{{ run.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px; min-width: 100px;">
                                            <div class="progress-bar" 
                                                 role="progressbar" 
                                                 style="width: {{ run.progress.percentage }}%"
                                                 aria-valuenow="{{ run.progress.percentage }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ run.progress.completed }}/{{ run.progress.total }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ run.created_at|date:"M d, Y H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if run.duration %}
                                        <small>{{ run.duration|floatformat:1 }}s</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            {% if run.created_by %}
                                            {{ run.created_by.username }}
                                            {% else %}
                                            <em class="text-muted">System</em>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-info-circle fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No workflow runs for this paper yet</h5>
                        <p class="text-muted">This paper has not been analyzed by any workflow.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Node Details Modal -->
<div class="modal fade" id="nodeDetailsModal" tabindex="-1" role="dialog" aria-labelledby="nodeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="nodeDetailsModalLabel">
                    <i class="fas fa-code mr-2"></i>Node Execution Details
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="node-details-content">
                <div class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading node details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Mermaid
mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'basis',
        padding: 15,
        nodeSpacing: 120,
        rankSpacing: 100,
        width: '100%'
    },
    securityLevel: 'loose',
    fontFamily: 'Arial, sans-serif',
    fontSize: 18
});

// Render workflow DAG
$(document).ready(function() {
    const nodesData = {{ workflow_nodes_json|safe }};
    const edges = {{ workflow_edges|safe }};
    
    if (Object.keys(nodesData).length > 0) {
        // Build Mermaid graph syntax
        let mermaidSyntax = 'graph LR\n';
        
        // Add nodes with styling based on status
        for (const [nodeId, nodeData] of Object.entries(nodesData)) {
            let statusIcon = '';
            if (nodeData.status === 'completed') {
                statusIcon = '✓';
            } else if (nodeData.status === 'running') {
                statusIcon = '⟳';
            } else if (nodeData.status === 'failed') {
                statusIcon = '✗';
            } else {
                statusIcon = '○';
            }
            const label = `${statusIcon}  ${nodeData.display_name}`;
            mermaidSyntax += `    ${nodeId}["${label}"]:::${nodeData.status}\n`;
        }
        
        // Add edges
        edges.forEach(edge => {
            mermaidSyntax += `    ${edge.from} --> ${edge.to}\n`;
        });
        
        // Add click events
        for (const [nodeId, nodeData] of Object.entries(nodesData)) {
            mermaidSyntax += `    click ${nodeId} clickNode\n`;
        }
        
        // Render the diagram
        const mermaidDiv = document.createElement('div');
        mermaidDiv.className = 'mermaid';
        mermaidDiv.textContent = mermaidSyntax;
        $('#workflow-mermaid').html(mermaidDiv);
        
        // Render with callback
        mermaid.init(undefined, mermaidDiv).then(() => {
            console.log('Mermaid diagram rendered successfully');
            
            // Add SVG gradients for beautiful node fills
            const svg = $('#workflow-mermaid svg')[0];
            if (svg) {
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                
                // Completed gradient (green)
                const gradCompleted = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                gradCompleted.setAttribute('id', 'gradient-completed');
                gradCompleted.setAttribute('x1', '0%');
                gradCompleted.setAttribute('y1', '0%');
                gradCompleted.setAttribute('x2', '100%');
                gradCompleted.setAttribute('y2', '100%');
                gradCompleted.innerHTML = `
                    <stop offset="0%" style="stop-color:#16a085;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#1abc9c;stop-opacity:1" />
                `;
                
                // Running gradient (blue with animation)
                const gradRunning = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                gradRunning.setAttribute('id', 'gradient-running');
                gradRunning.setAttribute('x1', '0%');
                gradRunning.setAttribute('y1', '0%');
                gradRunning.setAttribute('x2', '100%');
                gradRunning.setAttribute('y2', '100%');
                gradRunning.innerHTML = `
                    <stop offset="0%" style="stop-color:#2874a6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#3498db;stop-opacity:1" />
                `;
                
                // Failed gradient (red)
                const gradFailed = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                gradFailed.setAttribute('id', 'gradient-failed');
                gradFailed.setAttribute('x1', '0%');
                gradFailed.setAttribute('y1', '0%');
                gradFailed.setAttribute('x2', '100%');
                gradFailed.setAttribute('y2', '100%');
                gradFailed.innerHTML = `
                    <stop offset="0%" style="stop-color:#c0392b;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#e74c3c;stop-opacity:1" />
                `;
                
                // Pending gradient (yellow/gold)
                const gradPending = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                gradPending.setAttribute('id', 'gradient-pending');
                gradPending.setAttribute('x1', '0%');
                gradPending.setAttribute('y1', '0%');
                gradPending.setAttribute('x2', '100%');
                gradPending.setAttribute('y2', '100%');
                gradPending.innerHTML = `
                    <stop offset="0%" style="stop-color:#d4ac0d;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f4d03f;stop-opacity:1" />
                `;
                
                defs.appendChild(gradCompleted);
                defs.appendChild(gradRunning);
                defs.appendChild(gradFailed);
                defs.appendChild(gradPending);
                
                svg.insertBefore(defs, svg.firstChild);
                
                // Round rectangle corners for nodes
                svg.querySelectorAll('.node rect').forEach(rect => {
                    rect.setAttribute('rx', '8');
                    rect.setAttribute('ry', '8');
                });
            }
        }).catch(err => {
            console.error('Mermaid rendering error:', err);
        });
        
        // Setup click handler
        window.clickNode = function(nodeId) {
            console.log('Node clicked:', nodeId);
            console.log('All nodes:', nodesData);
            const nodeData = Object.values(nodesData).find(n => n.node_id === nodeId);
            console.log('Found node data:', nodeData);
            if (nodeData) {
                showNodeDetails(nodeData.id, nodeData.display_name);
            } else {
                console.error('Node data not found for:', nodeId);
            }
        };
    }
});

function showNodeDetails(nodeId, nodeName) {
    console.log('showNodeDetails called with:', nodeId, nodeName);
    $('#nodeDetailsModal').modal('show');
    $('#nodeDetailsModalLabel').html('<i class="fas fa-code mr-2"></i>Node: ' + nodeName);
    
    // Show loading state
    $('#node-details-content').html(
        '<div class="text-center py-4">' +
        '<i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>' +
        '<p>Loading node details...</p>' +
        '</div>'
    );
    
    // Load node details via AJAX
    $.ajax({
        url: '/workflow/node/' + nodeId + '/',
        method: 'GET',
        success: function(data) {
            renderNodeDetails(data);
        },
        error: function(xhr, status, error) {
            console.error('AJAX Error:', status, error);
            console.error('Response:', xhr.responseText);
            console.error('Node ID:', nodeId);
            $('#node-details-content').html(
                '<div class="alert alert-danger">' +
                '<i class="fas fa-exclamation-triangle mr-2"></i>' +
                'Failed to load node details.<br>' +
                '<small class="text-muted">Error: ' + error + ' (Status: ' + xhr.status + ')</small>' +
                '</div>'
            );
        }
    });
}

function renderNodeDetails(node) {
    let statusBadge = '';
    let statusIcon = '';
    
    if (node.status === 'completed') {
        statusBadge = '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Completed</span>';
        statusIcon = '✓';
    } else if (node.status === 'running') {
        statusBadge = '<span class="badge badge-info"><i class="fas fa-spinner fa-spin"></i> Running</span>';
        statusIcon = '●';
    } else if (node.status === 'failed') {
        statusBadge = '<span class="badge badge-danger"><i class="fas fa-times-circle"></i> Failed</span>';
        statusIcon = '✗';
    } else if (node.status === 'pending' || node.status === 'ready') {
        statusBadge = '<span class="badge badge-warning"><i class="fas fa-clock"></i> ' + node.status + '</span>';
        statusIcon = '⏳';
    } else {
        statusBadge = '<span class="badge badge-secondary">' + node.status + '</span>';
        statusIcon = '○';
    }
    
    let html = `
        <div class="mb-4">
            <h6 class="border-bottom pb-2">
                <i class="fas fa-info-circle text-primary mr-2"></i>Node Information
            </h6>
            <table class="table table-sm">
                <tr>
                    <th style="width: 25%;">Node ID:</th>
                    <td><code>${node.node_id}</code></td>
                </tr>
                <tr>
                    <th>Node Type:</th>
                    <td>${node.node_type}</td>
                </tr>
                <tr>
                    <th>Handler:</th>
                    <td><code>${node.handler}</code></td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td>${statusBadge}</td>
                </tr>
                <tr>
                    <th>Attempts:</th>
                    <td>${node.attempt_count} / ${node.max_retries}</td>
                </tr>
    `;
    
    if (node.started_at) {
        html += `
                <tr>
                    <th>Started:</th>
                    <td>${node.started_at}</td>
                </tr>
        `;
    }
    
    if (node.completed_at) {
        html += `
                <tr>
                    <th>Completed:</th>
                    <td>${node.completed_at}</td>
                </tr>
        `;
    }
    
    if (node.duration) {
        html += `
                <tr>
                    <th>Duration:</th>
                    <td>${node.duration.toFixed(2)}s</td>
                </tr>
        `;
    }
    
    if (node.celery_task_id) {
        html += `
                <tr>
                    <th>Celery Task ID:</th>
                    <td><code>${node.celery_task_id}</code></td>
                </tr>
        `;
    }
    
    html += `
            </table>
        </div>
    `;
    
    // Console/Terminal Log
    html += `
        <div class="mb-4">
            <h6 class="border-bottom pb-2">
                <i class="fas fa-terminal text-primary mr-2"></i>Execution Log
            </h6>
            <div class="terminal-output" style="max-height: 400px;">
    `;
    
    if (node.error_message || node.error_traceback) {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.started_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-error">Error occurred during execution</span>
                </div>
        `;
        
        if (node.error_message) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-error"><strong>Error Message:</strong> ${escapeHtml(node.error_message)}</span>
                </div>
            `;
        }
        
        if (node.error_traceback) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-error"><strong>Traceback:</strong></span>
                </div>
                <div class="terminal-line">
                    <pre class="terminal-error mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(node.error_traceback)}</pre>
                </div>
            `;
        }
    } else if (node.status === 'completed') {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.completed_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-success">Node executed successfully</span>
                </div>
        `;
        
        if (node.output_data && Object.keys(node.output_data).length > 0) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-info">Output data available (see below)</span>
                </div>
            `;
        }
    } else if (node.status === 'running') {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.started_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-info">Node is currently executing...</span>
                </div>
        `;
    } else {
        html += `
                <div class="terminal-line">
                    <span class="terminal-info">Node has not started execution yet</span>
                </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    // Output Data
    if (node.output_data && Object.keys(node.output_data).length > 0) {
        html += `
            <div class="mb-3">
                <h6 class="border-bottom pb-2">
                    <i class="fas fa-database text-primary mr-2"></i>Output Data
                </h6>
                <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(node.output_data, null, 2))}</code></pre>
            </div>
        `;
    }
    
    // Input Data
    if (node.input_data && Object.keys(node.input_data).length > 0) {
        html += `
            <div class="mb-3">
                <h6 class="border-bottom pb-2">
                    <i class="fas fa-inbox text-primary mr-2"></i>Input Data
                </h6>
                <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(node.input_data, null, 2))}</code></pre>
            </div>
        `;
    }
    
    $('#node-details-content').html(html);
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>
{% endblock %}
