{% extends "base.html" %}
{% load static %}

{% block head_title %}{{ paper.title }} - Details{% endblock %}

{% block extra_head %}
<!-- Mermaid.js for DAG visualization -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
    .workflow-diagram-container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 30px;
    }
    
    .mermaid-diagram {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
    }
    
    /* Mermaid node styling overrides */
    .mermaid .node rect,
    .mermaid .node circle {
        stroke-width: 2px;
    }
    
    .mermaid .node.completed rect {
        fill: #1abc9c !important;
        stroke: #0e8c82 !important;
    }
    
    .mermaid .node.running rect {
        fill: #3498db !important;
        stroke: #2980b9 !important;
    }
    
    .mermaid .node.failed rect {
        fill: #e74c3c !important;
        stroke: #c0392b !important;
    }
    
    .mermaid .node.pending rect {
        fill: #f4d03f !important;
        stroke: #e2b90a !important;
    }
    
    .mermaid .edgeLabel {
        background-color: white;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    .clickable-node {
        cursor: pointer;
    }
    
    .node-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid;
    }
    
    .legend-box.completed {
        background: #1abc9c;
        border-color: #0e8c82;
    }
    
    .legend-box.running {
        background: #3498db;
        border-color: #2980b9;
    }
    
    .legend-box.failed {
        background: #e74c3c;
        border-color: #c0392b;
    }
    
    .legend-box.pending {
        background: #f4d03f;
        border-color: #e2b90a;
    }
    
    .status-badge-large {
        font-size: 0.7rem;
        padding: 2px 6px;
        position: absolute;
        top: 2px;
        right: 2px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <!-- Paper Header -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h4 class="mb-2">
                                <i class="fas fa-file-pdf mr-2"></i>{{ paper.title }}
                            </h4>
                            <div class="small">
                                {% if paper.conference %}
                                <span class="mr-3">
                                    <i class="fas fa-building mr-1"></i>
                                    <a href="{% url 'conference_detail' paper.conference.id %}" class="text-white">
                                        {{ paper.conference.name }}{% if paper.conference.year %} {{ paper.conference.year }}{% endif %}
                                    </a>
                                </span>
                                {% endif %}
                                {% if paper.doi %}
                                <span class="mr-3"><i class="fas fa-fingerprint mr-1"></i>{{ paper.doi }}</span>
                                {% endif %}
                                {% if paper.authors %}
                                <span><i class="fas fa-users mr-1"></i>{{ paper.authors|truncatewords:5 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            {% if paper.conference %}
                            <a href="{% url 'conference_detail' paper.conference.id %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left mr-1"></i> Back
                            </a>
                            {% else %}
                            <a href="{% url 'conference_list' %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left mr-1"></i> Conferences
                            </a>
                            {% endif %}
                            {% if paper.file %}
                            <a href="{{ paper.file.url }}" target="_blank" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-download mr-1"></i> Download PDF
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Workflow Diagram -->
            {% if latest_workflow %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram mr-2"></i>Latest Workflow Analysis
                        </h5>
                        <div>
                            <span class="badge badge-{{ latest_workflow.status|lower }}">
                                {% if latest_workflow.status == 'completed' %}
                                <i class="fas fa-check-circle"></i> Completed
                                {% elif latest_workflow.status == 'running' %}
                                <i class="fas fa-spinner fa-spin"></i> Running
                                {% elif latest_workflow.status == 'failed' %}
                                <i class="fas fa-times-circle"></i> Failed
                                {% elif latest_workflow.status == 'pending' %}
                                <i class="fas fa-clock"></i> Pending
                                {% else %}
                                {{ latest_workflow.status|title }}
                                {% endif %}
                            </span>
                            <small class="text-muted ml-2">
                                Run #{{ latest_workflow.run_number }} • 
                                {{ latest_workflow.created_at|date:"M d, Y H:i" }}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body workflow-diagram-container">
                    <!-- Mermaid DAG Diagram -->
                    <div class="mermaid-diagram" id="workflow-mermaid">
                        <!-- Mermaid syntax will be inserted here -->
                    </div>
                    
                    <div class="node-legend">
                        <div class="legend-item">
                            <div class="legend-box completed"></div>
                            <span><i class="fas fa-check-circle text-success"></i> Completed</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box running"></div>
                            <span><i class="fas fa-spinner text-info"></i> Running</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box failed"></div>
                            <span><i class="fas fa-times-circle text-danger"></i> Failed</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box pending"></div>
                            <span><i class="fas fa-clock text-warning"></i> Pending</span>
                        </div>
                    </div>
                    
                    <div class="text-muted text-center mt-3 small">
                        <i class="fas fa-info-circle mr-1"></i> Click on any node to view execution details and logs
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Other Workflow Runs -->
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-history mr-2"></i>Workflow Run History
                        <span class="badge badge-secondary ml-2">{{ workflow_runs.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if workflow_runs %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Run #</th>
                                    <th>Workflow</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Started</th>
                                    <th>Duration</th>
                                    <th>Created By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for run in workflow_runs %}
                                <tr class="{% if run.id == latest_workflow.id %}table-active{% endif %}">
                                    <td>
                                        <strong>#{{ run.run_number }}</strong>
                                        {% if run.id == latest_workflow.id %}
                                        <span class="badge badge-info ml-1">Latest</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ run.workflow_definition.name }}
                                            <span class="text-muted">(v{{ run.workflow_definition.version }})</span>
                                        </small>
                                    </td>
                                    <td>
                                        {% if run.status == 'completed' %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> Completed
                                        </span>
                                        {% elif run.status == 'running' %}
                                        <span class="badge badge-info">
                                            <i class="fas fa-spinner fa-spin"></i> Running
                                        </span>
                                        {% elif run.status == 'failed' %}
                                        <span class="badge badge-danger">
                                            <i class="fas fa-times-circle"></i> Failed
                                        </span>
                                        {% elif run.status == 'pending' %}
                                        <span class="badge badge-warning">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                        {% else %}
                                        <span class="badge badge-secondary">{{ run.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px; min-width: 100px;">
                                            <div class="progress-bar" 
                                                 role="progressbar" 
                                                 style="width: {{ run.progress.percentage }}%"
                                                 aria-valuenow="{{ run.progress.percentage }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ run.progress.completed }}/{{ run.progress.total }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ run.created_at|date:"M d, Y H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if run.duration %}
                                        <small>{{ run.duration|floatformat:1 }}s</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            {% if run.created_by %}
                                            {{ run.created_by.username }}
                                            {% else %}
                                            <em class="text-muted">System</em>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-info-circle fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No workflow runs for this paper yet</h5>
                        <p class="text-muted">This paper has not been analyzed by any workflow.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Node Details Modal -->
<div class="modal fade" id="nodeDetailsModal" tabindex="-1" role="dialog" aria-labelledby="nodeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="nodeDetailsModalLabel">
                    <i class="fas fa-code mr-2"></i>Node Execution Details
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="node-details-content">
                <div class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading node details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Mermaid
mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis',
        padding: 20
    },
    securityLevel: 'loose'
});

// Render workflow DAG
$(document).ready(function() {
    const nodesData = {{ workflow_nodes_json|safe }};
    const edges = {{ workflow_edges|safe }};
    
    if (Object.keys(nodesData).length > 0) {
        // Build Mermaid graph syntax
        let mermaidSyntax = 'graph LR\n';
        
        // Add nodes with styling based on status
        for (const [nodeId, nodeData] of Object.entries(nodesData)) {
            const statusIcon = nodeData.status === 'completed' ? '✓' : 
                             nodeData.status === 'running' ? '⟳' :
                             nodeData.status === 'failed' ? '✗' : '○';
            const label = `${statusIcon} ${nodeData.display_name}`;
            mermaidSyntax += `    ${nodeId}["${label}"]:::${nodeData.status}\n`;
        }
        
        // Add edges
        edges.forEach(edge => {
            mermaidSyntax += `    ${edge.from} --> ${edge.to}\n`;
        });
        
        // Add click events
        for (const [nodeId, nodeData] of Object.entries(nodesData)) {
            mermaidSyntax += `    click ${nodeId} call showNodeDetails('${nodeData.id}', '${nodeData.display_name}')\n`;
        }
        
        // Render the diagram
        $('#workflow-mermaid').html('<div class="mermaid">' + mermaidSyntax + '</div>');
        mermaid.init(undefined, '.mermaid');
    }
});

function showNodeDetails(nodeId, nodeName) {
    $('#nodeDetailsModal').modal('show');
    $('#nodeDetailsModalLabel').html('<i class="fas fa-code mr-2"></i>Node: ' + nodeName);
    
    // Load node details via AJAX
    $.ajax({
        url: '/workflow/node/' + nodeId + '/',
        method: 'GET',
        success: function(data) {
            renderNodeDetails(data);
        },
        error: function() {
            $('#node-details-content').html(
                '<div class="alert alert-danger">' +
                '<i class="fas fa-exclamation-triangle mr-2"></i>' +
                'Failed to load node details.' +
                '</div>'
            );
        }
    });
}

function renderNodeDetails(node) {
    let statusBadge = '';
    let statusIcon = '';
    
    if (node.status === 'completed') {
        statusBadge = '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Completed</span>';
        statusIcon = '✓';
    } else if (node.status === 'running') {
        statusBadge = '<span class="badge badge-info"><i class="fas fa-spinner fa-spin"></i> Running</span>';
        statusIcon = '●';
    } else if (node.status === 'failed') {
        statusBadge = '<span class="badge badge-danger"><i class="fas fa-times-circle"></i> Failed</span>';
        statusIcon = '✗';
    } else if (node.status === 'pending' || node.status === 'ready') {
        statusBadge = '<span class="badge badge-warning"><i class="fas fa-clock"></i> ' + node.status + '</span>';
        statusIcon = '⏳';
    } else {
        statusBadge = '<span class="badge badge-secondary">' + node.status + '</span>';
        statusIcon = '○';
    }
    
    let html = `
        <div class="mb-4">
            <h6 class="border-bottom pb-2">
                <i class="fas fa-info-circle text-primary mr-2"></i>Node Information
            </h6>
            <table class="table table-sm">
                <tr>
                    <th style="width: 25%;">Node ID:</th>
                    <td><code>${node.node_id}</code></td>
                </tr>
                <tr>
                    <th>Node Type:</th>
                    <td>${node.node_type}</td>
                </tr>
                <tr>
                    <th>Handler:</th>
                    <td><code>${node.handler}</code></td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td>${statusBadge}</td>
                </tr>
                <tr>
                    <th>Attempts:</th>
                    <td>${node.attempt_count} / ${node.max_retries}</td>
                </tr>
    `;
    
    if (node.started_at) {
        html += `
                <tr>
                    <th>Started:</th>
                    <td>${node.started_at}</td>
                </tr>
        `;
    }
    
    if (node.completed_at) {
        html += `
                <tr>
                    <th>Completed:</th>
                    <td>${node.completed_at}</td>
                </tr>
        `;
    }
    
    if (node.duration) {
        html += `
                <tr>
                    <th>Duration:</th>
                    <td>${node.duration.toFixed(2)}s</td>
                </tr>
        `;
    }
    
    if (node.celery_task_id) {
        html += `
                <tr>
                    <th>Celery Task ID:</th>
                    <td><code>${node.celery_task_id}</code></td>
                </tr>
        `;
    }
    
    html += `
            </table>
        </div>
    `;
    
    // Console/Terminal Log
    html += `
        <div class="mb-4">
            <h6 class="border-bottom pb-2">
                <i class="fas fa-terminal text-primary mr-2"></i>Execution Log
            </h6>
            <div class="terminal-output" style="max-height: 400px;">
    `;
    
    if (node.error_message || node.error_traceback) {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.started_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-error">Error occurred during execution</span>
                </div>
        `;
        
        if (node.error_message) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-error"><strong>Error Message:</strong> ${escapeHtml(node.error_message)}</span>
                </div>
            `;
        }
        
        if (node.error_traceback) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-error"><strong>Traceback:</strong></span>
                </div>
                <div class="terminal-line">
                    <pre class="terminal-error mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(node.error_traceback)}</pre>
                </div>
            `;
        }
    } else if (node.status === 'completed') {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.completed_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-success">Node executed successfully</span>
                </div>
        `;
        
        if (node.output_data && Object.keys(node.output_data).length > 0) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-info">Output data available (see below)</span>
                </div>
            `;
        }
    } else if (node.status === 'running') {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.started_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-info">Node is currently executing...</span>
                </div>
        `;
    } else {
        html += `
                <div class="terminal-line">
                    <span class="terminal-info">Node has not started execution yet</span>
                </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    // Output Data
    if (node.output_data && Object.keys(node.output_data).length > 0) {
        html += `
            <div class="mb-3">
                <h6 class="border-bottom pb-2">
                    <i class="fas fa-database text-primary mr-2"></i>Output Data
                </h6>
                <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(node.output_data, null, 2))}</code></pre>
            </div>
        `;
    }
    
    // Input Data
    if (node.input_data && Object.keys(node.input_data).length > 0) {
        html += `
            <div class="mb-3">
                <h6 class="border-bottom pb-2">
                    <i class="fas fa-inbox text-primary mr-2"></i>Input Data
                </h6>
                <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(node.input_data, null, 2))}</code></pre>
            </div>
        `;
    }
    
    $('#node-details-content').html(html);
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>
{% endblock %}
