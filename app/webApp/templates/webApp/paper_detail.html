{% extends "base.html" %}
{% load static %}

{% block head_title %}{{ paper.title }} - Details{% endblock %}

{% block extra_head %}
<!-- Mermaid.js for DAG visualization -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
    .workflow-diagram-container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 30px;
        min-height: 500px;
    }
    
    .mermaid-diagram {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 450px;
        width: 100%;
    }
    
    .mermaid-diagram .mermaid {
        width: 100%;
        min-height: 450px;
    }
    
    .mermaid-diagram svg {
        max-width: 100%;
        height: auto;
        min-height: 450px;
    }
    
    /* Mermaid node styling overrides */
    .mermaid .node rect,
    .mermaid .node circle {
        stroke-width: 3px;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        transition: all 0.3s ease;
    }
    
    .mermaid .node:hover rect,
    .mermaid .node:hover circle {
        filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.15));
        transform: translateY(-2px);
    }
    
    .mermaid .node.completed rect {
        fill: url(#gradient-completed) !important;
        stroke: #0a7a6e !important;
    }
    
    .mermaid .node.running rect {
        fill: url(#gradient-running) !important;
        stroke: #2471a3 !important;
        animation: pulse-running 1.5s ease-in-out infinite, glow-running 2s ease-in-out infinite;
    }
    
    .mermaid .node.failed rect {
        fill: url(#gradient-failed) !important;
        stroke: #a93226 !important;
    }
    
    .mermaid .node.pending rect {
        fill: url(#gradient-pending) !important;
        stroke: #d4ac0d !important;
    }
    
    /* Node text styling */
    .mermaid .nodeLabel {
        color: white !important;
        font-weight: 600 !important;
        font-size: 17px !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    /* Edge styling */
    .mermaid .edgePath path {
        stroke: #5d6d7e !important;
        stroke-width: 2.5px !important;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.1));
    }
    
    .mermaid .arrowheadPath {
        fill: #5d6d7e !important;
        stroke: #5d6d7e !important;
    }
    
    .mermaid .edgeLabel {
        background-color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Animations for running nodes */
    @keyframes pulse-running {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.85;
        }
    }
    
    @keyframes glow-running {
        0%, 100% {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)) drop-shadow(0 0 0 rgba(52, 152, 219, 0));
        }
        50% {
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.15)) drop-shadow(0 0 20px rgba(52, 152, 219, 0.6));
        }
    }
    
    .clickable-node {
        cursor: pointer;
    }
    
    /* Hide edge labels completely - not needed for this workflow visualization */
    .mermaid g.edgeLabels,
    .mermaid .edgeLabels {
        display: none !important;
    }
    
    /* Style arrowheads properly */
    .mermaid marker path {
        fill: #5d6d7e !important;
    }
    
    /* Add SVG gradients for nodes */
    .mermaid svg defs {
        display: block;
    }
    
    /* Workflow run row hover effect */
    .workflow-run-row:hover {
        background-color: rgba(0, 123, 255, 0.1) !important;
        transition: background-color 0.2s ease;
    }
    
    .node-legend {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .legend-items {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .legend-help {
        white-space: nowrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
        color: #34495e;
    }
    
    .legend-item i {
        font-size: 16px;
    }
    
    /* Terminal/Console Log Styling */
    .terminal-output {
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Courier New', Consolas, monospace;
        font-size: 13px;
        padding: 15px;
        border-radius: 4px;
        overflow-y: auto;
        line-height: 1.6;
        scroll-behavior: smooth;
    }
    
    .terminal-line {
        margin-bottom: 6px;
        padding: 2px 0;
    }
    
    .terminal-time {
        color: #808080;
        margin-right: 8px;
        font-size: 12px;
    }
    
    .terminal-prompt {
        margin-right: 8px;
        font-weight: bold;
    }
    
    .terminal-success {
        color: #4ec9b0;
    }
    
    .terminal-info {
        color: #d4d4d4;
    }
    
    .terminal-warning {
        color: #dcdcaa;
    }
    
    .terminal-error {
        color: #f48771;
    }
    
    .terminal-debug {
        color: #9cdcfe;
        opacity: 0.8;
        font-size: 12px;
    }
    
    /* Fixed header in node details modal */
    #nodeDetailsModal .modal-dialog {
        max-height: 90vh;
        margin: 1.75rem auto;
    }
    
    #nodeDetailsModal .modal-content {
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    #nodeDetailsModal .modal-body {
        overflow-y: auto;
        flex: 1;
    }
    
    #nodeDetailsModal .modal-header,
    #nodeDetailsModal .modal-footer {
        flex-shrink: 0;
    }
    
    .legend-box {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 2px solid;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .legend-box.completed {
        background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
        border-color: #0a7a6e;
    }
    
    .legend-box.running {
        background: linear-gradient(135deg, #2874a6 0%, #3498db 100%);
        border-color: #2471a3;
        animation: pulse-running 2s ease-in-out infinite;
    }
    
    .legend-box.failed {
        background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        border-color: #a93226;
    }
    
    .legend-box.pending {
        background: linear-gradient(135deg, #d4ac0d 0%, #f4d03f 100%);
        border-color: #d4ac0d;
    }
    
    .status-badge-large {
        font-size: 0.7rem;
        padding: 2px 6px;
        position: absolute;
        top: 2px;
        right: 2px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <!-- Paper Header -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h4 class="mb-2">
                                <i class="fas fa-file-pdf mr-2"></i>{{ paper.title }}
                            </h4>
                            <div class="small">
                                {% if paper.conference %}
                                <span class="mr-3">
                                    <i class="fas fa-building mr-1"></i>
                                    <a href="{% url 'conference_detail' paper.conference.id %}" class="text-white">
                                        {{ paper.conference.name }}{% if paper.conference.year %} {{ paper.conference.year }}{% endif %}
                                    </a>
                                </span>
                                {% endif %}
                                {% if paper.doi %}
                                <span class="mr-3"><i class="fas fa-fingerprint mr-1"></i>{{ paper.doi }}</span>
                                {% endif %}
                                {% if paper.authors %}
                                <span><i class="fas fa-users mr-1"></i>{{ paper.authors|truncatewords:5 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            {% if paper.conference %}
                            <a href="{% url 'conference_detail' paper.conference.id %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left mr-1"></i> Back
                            </a>
                            {% else %}
                            <a href="{% url 'conference_list' %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left mr-1"></i> Conferences
                            </a>
                            {% endif %}
                            {% if paper.file %}
                            <a href="{{ paper.file.url }}" target="_blank" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-download mr-1"></i> Download PDF
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Workflow Diagram -->
            {% if selected_workflow %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram mr-2"></i>
                            {% if selected_workflow.id == latest_workflow.id %}
                            Latest Workflow Analysis
                            {% else %}
                            Workflow Analysis (Run #{{ selected_workflow.run_number }})
                            {% endif %}
                        </h5>
                        <div class="d-flex align-items-center">
                            <span class="badge badge-{{ selected_workflow.status|lower }}">
                                {% if selected_workflow.status == 'completed' %}
                                <i class="fas fa-check-circle"></i> Completed
                                {% elif selected_workflow.status == 'running' %}
                                <i class="fas fa-spinner fa-spin"></i> Running
                                {% elif selected_workflow.status == 'failed' %}
                                <i class="fas fa-times-circle"></i> Failed
                                {% elif selected_workflow.status == 'pending' %}
                                <i class="fas fa-clock"></i> Pending
                                {% else %}
                                {{ selected_workflow.status|title }}
                                {% endif %}
                            </span>
                            <small class="text-muted ml-2">
                                Run #{{ selected_workflow.run_number }} ‚Ä¢ 
                                {{ selected_workflow.created_at|date:"M d, Y H:i" }}
                            </small>
                            {% if selected_workflow.status == 'running' or selected_workflow.status == 'pending' %}
                            <span class="badge badge-light ml-3 border" id="auto-update-indicator">
                                <i class="fas fa-sync-alt fa-spin"></i> Auto-updating
                            </span>
                            {% endif %}
                            {% if selected_workflow.id == latest_workflow.id and selected_workflow.status not in 'running,pending' %}
                            <button class="btn btn-sm btn-outline-primary ml-3" id="rerun-workflow-btn" onclick="rerunWorkflow({{ paper.id }})">
                                <i class="fas fa-redo mr-1"></i> Rerun Analysis
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% if selected_workflow.id != latest_workflow.id %}
                <div class="card-body py-2 bg-light border-bottom">
                    <div class="alert alert-info mb-0 py-2">
                        <i class="fas fa-info-circle mr-2"></i>
                        You are viewing an older workflow run. 
                        <a href="?" class="btn btn-sm btn-primary ml-3">
                            <i class="fas fa-arrow-left mr-1"></i>Back to Latest
                        </a>
                    </div>
                </div>
                {% endif %}
                <div class="card-body workflow-diagram-container mb-0">
                    <!-- Mermaid DAG Diagram -->
                    <div class="mermaid-diagram" id="workflow-mermaid">
                        <!-- Mermaid syntax will be inserted here -->
                    </div>
                    
                    <div class="node-legend">
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-box completed"></div>
                                <span><i class="fas fa-check-circle text-success"></i> Completed</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box running"></div>
                                <span><i class="fas fa-spinner text-info"></i> Running</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box failed"></div>
                                <span><i class="fas fa-times-circle text-danger"></i> Failed</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box pending"></div>
                                <span><i class="fas fa-clock text-warning"></i> Pending</span>
                            </div>
                        </div>
                        <div class="legend-help text-muted small">
                            <i class="fas fa-info-circle mr-1"></i> Click on any node to view execution details and logs
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- No workflow section -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram mr-2"></i>Workflow Analysis
                    </h5>
                </div>
                <div class="card-body text-center py-5">
                    <i class="fas fa-robot fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No Analysis Yet</h5>
                    <p class="text-muted">Start analyzing this paper to generate a comprehensive reproducibility assessment.</p>
                    <button class="btn btn-primary btn-lg mt-3" onclick="rerunWorkflow({{ paper.id }})">
                        <i class="fas fa-play mr-2"></i> Start Analysis
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Other Workflow Runs -->
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-history mr-2"></i>Workflow Run History
                        <span class="badge badge-secondary ml-2">{{ workflow_runs.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if workflow_runs %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Run #</th>
                                    <th>Workflow</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Started</th>
                                    <th>Duration</th>
                                    <th>Created By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for run in workflow_runs %}
                                <tr class="workflow-run-row {% if run.id == selected_workflow.id %}table-primary{% elif run.id == latest_workflow.id %}table-active{% endif %}" 
                                    onclick="window.location.href='?workflow_run={{ run.id }}'" 
                                    style="cursor: pointer;">
                                    <td>
                                        <strong>#{{ run.run_number }}</strong>
                                        {% if run.id == latest_workflow.id %}
                                        <span class="badge badge-info ml-1">Latest</span>
                                        {% endif %}
                                        {% if run.id == selected_workflow.id %}
                                        <span class="badge badge-primary ml-1">Viewing</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ run.workflow_definition.name }}
                                            <span class="text-muted">(v{{ run.workflow_definition.version }})</span>
                                        </small>
                                    </td>
                                    <td>
                                        {% if run.status == 'completed' %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> Completed
                                        </span>
                                        {% elif run.status == 'running' %}
                                        <span class="badge badge-info">
                                            <i class="fas fa-spinner fa-spin"></i> Running
                                        </span>
                                        {% elif run.status == 'failed' %}
                                        <span class="badge badge-danger">
                                            <i class="fas fa-times-circle"></i> Failed
                                        </span>
                                        {% elif run.status == 'pending' %}
                                        <span class="badge badge-warning">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                        {% else %}
                                        <span class="badge badge-secondary">{{ run.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px; min-width: 100px;">
                                            <div class="progress-bar" 
                                                 role="progressbar" 
                                                 style="width: {{ run.progress.percentage }}%"
                                                 aria-valuenow="{{ run.progress.percentage }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ run.progress.completed }}/{{ run.progress.total }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ run.created_at|date:"M d, Y H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if run.duration %}
                                        <small>{{ run.duration|floatformat:1 }}s</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            {% if run.created_by %}
                                            {{ run.created_by.username }}
                                            {% else %}
                                            <em class="text-muted">System</em>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-info-circle fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No workflow runs for this paper yet</h5>
                        <p class="text-muted">This paper has not been analyzed by any workflow.</p>
                        <button class="btn btn-primary mt-3" id="start-workflow-btn" onclick="rerunWorkflow({{ paper.id }})">
                            <i class="fas fa-play mr-2"></i> Start Analysis
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Node Details Modal -->
<div class="modal fade" id="nodeDetailsModal" tabindex="-1" role="dialog" aria-labelledby="nodeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="nodeDetailsModalLabel">
                    <i class="fas fa-code mr-2"></i>Node Execution Details
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="node-details-content">
                <div class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading node details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="rerun-node-btn" onclick="rerunNode()">
                    <i class="fas fa-redo mr-2"></i>Rerun This Node
                </button>
                <button type="button" class="btn btn-info" id="rerun-from-node-btn" onclick="rerunFromNode()">
                    <i class="fas fa-play mr-2"></i>Rerun From Here
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Rerun Workflow -->
<div class="modal fade" id="rerunWorkflowModal" tabindex="-1" role="dialog" aria-labelledby="rerunWorkflowModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="rerunWorkflowModalLabel">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Workflow Run
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to run the workflow analysis?</p>
                
                <!-- Workflow Selection -->
                <div class="form-group">
                    <label for="workflow-type-select" class="font-weight-bold">
                        <i class="fas fa-project-diagram mr-1"></i>Select Workflow:
                    </label>
                    <select class="form-control" id="workflow-type-select">
                        <option value="" disabled>Loading workflows...</option>
                    </select>
                    <small class="form-text text-muted" id="workflow-description">
                        Select a workflow to run
                    </small>
                </div>
                
                <!-- Force Reprocess Option -->
                <div class="form-group">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="force-reprocess-checkbox" checked>
                        <label class="custom-control-label" for="force-reprocess-checkbox">
                            <i class="fas fa-sync-alt mr-1"></i>
                            <strong>Force reprocess</strong>
                        </label>
                        <small class="form-text text-muted ml-4">
                            When checked, all nodes will be reprocessed even if cached results exist. Uncheck to reuse cached data where possible.
                        </small>
                    </div>
                </div>
                
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Note:</strong> This will create a new workflow run and may take several minutes to complete. The analysis will process the paper and repository from scratch.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirm-rerun-btn">
                    <i class="fas fa-redo mr-1"></i> Yes, Run Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Rerun Single Node -->
<div class="modal fade" id="rerunNodeModal" tabindex="-1" role="dialog" aria-labelledby="rerunNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="rerunNodeModalLabel">
                    <i class="fas fa-redo mr-2"></i>Confirm Node Rerun
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to rerun this specific node?</p>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Note:</strong> This will re-execute only this node. Previous results for this node will be replaced, but other nodes in the workflow will remain unchanged.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-warning" id="confirm-rerun-node-btn">
                    <i class="fas fa-redo mr-1"></i> Yes, Rerun This Node
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Rerun From Node -->
<div class="modal fade" id="rerunFromNodeModal" tabindex="-1" role="dialog" aria-labelledby="rerunFromNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="rerunFromNodeModalLabel">
                    <i class="fas fa-play mr-2"></i>Confirm Rerun From Node
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to rerun the workflow from this node onwards?</p>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Note:</strong> This will create a new workflow run that:
                    <ul class="mb-0 mt-2">
                        <li>Keeps the results of all previous nodes (copied from current run)</li>
                        <li>Re-executes this node and all subsequent nodes</li>
                        <li>May take several minutes to complete</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-info" id="confirm-rerun-from-node-btn">
                    <i class="fas fa-play mr-1"></i> Yes, Rerun From Here
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Mermaid
mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'basis',
        padding: 15,
        nodeSpacing: 120,
        rankSpacing: 100,
        width: '100%'
    },
    securityLevel: 'loose',
    fontFamily: 'Arial, sans-serif',
    fontSize: 18
});

// Global variables
let nodesData = {{ workflow_nodes_json|safe }};
const edges = {{ workflow_edges|safe }};
const workflowRunId = {% if selected_workflow %}'{{ selected_workflow.id }}'{% else %}null{% endif %};
const workflowStatus = {% if selected_workflow %}'{{ selected_workflow.status }}'{% else %}null{% endif %};
let pollingInterval = null;
let nodeDetailsPollingInterval = null;
let currentNodeId = null;
let currentNodeStatus = null;

// Render workflow DAG
$(document).ready(function() {
    
    if (Object.keys(nodesData).length > 0) {
        // Initial render
        renderWorkflowDiagram(nodesData);
        
        // Setup click handler
        window.clickNode = function(nodeId) {
            console.log('Node clicked:', nodeId);
            console.log('All nodes:', nodesData);
            const nodeData = Object.values(nodesData).find(n => n.node_id === nodeId);
            console.log('Found node data:', nodeData);
            if (nodeData) {
                showNodeDetails(nodeData.id, nodeData.display_name);
            } else {
                console.error('Node data not found for:', nodeId);
            }
        };
    }
});

function showNodeDetails(nodeId, nodeName) {
    console.log('showNodeDetails called with:', nodeId, nodeName);
    
    // Store current node info
    currentNodeId = nodeId;
    
    $('#nodeDetailsModal').modal('show');
    updateModalTitle(nodeName, nodeId);
    
    // Load node details
    loadNodeDetails(nodeId);
}

function updateModalTitle(nodeName, status) {
    let liveIndicator = '';
    if (status === 'running' || status === 'pending') {
        liveIndicator = ' <span class="badge badge-info badge-sm ml-2"><i class="fas fa-sync-alt fa-spin"></i> Live</span>';
    }
    $('#nodeDetailsModalLabel').html('<i class="fas fa-code mr-2"></i>Node: ' + nodeName + liveIndicator);
}

function loadNodeDetails(nodeId) {
    // Show loading state only on first load
    if (!currentNodeStatus) {
        $('#node-details-content').html(
            '<div class="text-center py-4">' +
            '<i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>' +
            '<p>Loading node details...</p>' +
            '</div>'
        );
    }
    
    // Load node details via AJAX
    $.ajax({
        url: '/workflow/node/' + nodeId + '/',
        method: 'GET',
        success: function(data) {
            currentNodeStatus = data.status;
            renderNodeDetails(data);
            
            // Start polling if node is running or pending
            if ((data.status === 'running' || data.status === 'pending') && !nodeDetailsPollingInterval) {
                startNodeDetailsPolling(nodeId);
            } else if (data.status !== 'running' && data.status !== 'pending') {
                stopNodeDetailsPolling();
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX Error:', status, error);
            console.error('Response:', xhr.responseText);
            console.error('Node ID:', nodeId);
            $('#node-details-content').html(
                '<div class="alert alert-danger">' +
                '<i class="fas fa-exclamation-triangle mr-2"></i>' +
                'Failed to load node details.<br>' +
                '<small class="text-muted">Error: ' + error + ' (Status: ' + xhr.status + ')</small>' +
                '</div>'
            );
        }
    });
}

// Polling for node details updates
function startNodeDetailsPolling(nodeId) {
    if (nodeDetailsPollingInterval) return; // Already polling
    
    console.log('Starting node details polling for node:', nodeId);
    nodeDetailsPollingInterval = setInterval(function() {
        $.ajax({
            url: '/workflow/node/' + nodeId + '/',
            method: 'GET',
            success: function(data) {
                const previousStatus = currentNodeStatus;
                currentNodeStatus = data.status;
                
                // Update the modal content
                renderNodeDetails(data);
                
                // Stop polling if node completed
                if (data.status !== 'running' && data.status !== 'pending') {
                    console.log('Node completed, stopping polling');
                    stopNodeDetailsPolling();
                }
            },
            error: function(xhr, status, error) {
                console.error('Polling error:', error);
                // Don't stop polling on temporary errors
            }
        });
    }, 2000); // Poll every 2 seconds
}

function stopNodeDetailsPolling() {
    if (nodeDetailsPollingInterval) {
        console.log('Stopping node details polling');
        clearInterval(nodeDetailsPollingInterval);
        nodeDetailsPollingInterval = null;
    }
}

// Stop polling when modal is closed
$('#nodeDetailsModal').on('hidden.bs.modal', function() {
    stopNodeDetailsPolling();
    currentNodeId = null;
    currentNodeStatus = null;
});

function renderNodeDetails(node) {
    let statusBadge = '';
    let statusIcon = '';
    
    if (node.status === 'completed') {
        statusBadge = '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Completed</span>';
        statusIcon = '‚úì';
    } else if (node.status === 'running') {
        statusBadge = '<span class="badge badge-info"><i class="fas fa-spinner fa-spin"></i> Running</span>';
        statusIcon = '‚óè';
    } else if (node.status === 'failed') {
        statusBadge = '<span class="badge badge-danger"><i class="fas fa-times-circle"></i> Failed</span>';
        statusIcon = '‚úó';
    } else if (node.status === 'pending' || node.status === 'ready') {
        statusBadge = '<span class="badge badge-warning"><i class="fas fa-clock"></i> ' + node.status + '</span>';
        statusIcon = '‚è≥';
    } else {
        statusBadge = '<span class="badge badge-secondary">' + node.status + '</span>';
        statusIcon = '‚óã';
    }
    
    // Update modal title with status indicator
    const nodeData = Object.values(nodesData).find(n => n.node_id === node.node_id);
    if (nodeData) {
        updateModalTitle(nodeData.display_name, node.status);
    }
    
    let html = `
        <div class="mb-4">
            <h6 class="border-bottom pb-2">
                <i class="fas fa-info-circle text-primary mr-2"></i>Node Information
            </h6>
            <table class="table table-sm">
                <tr>
                    <th style="width: 25%;">Node ID:</th>
                    <td><code>${node.node_id}</code></td>
                </tr>
                <tr>
                    <th>Node Type:</th>
                    <td>${node.node_type}</td>
                </tr>
                <tr>
                    <th>Handler:</th>
                    <td><code>${node.handler}</code></td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td>${statusBadge}</td>
                </tr>
                <tr>
                    <th>Attempts:</th>
                    <td>${node.attempt_count} / ${node.max_retries}</td>
                </tr>
    `;
    
    if (node.started_at) {
        html += `
                <tr>
                    <th>Started:</th>
                    <td>${node.started_at}</td>
                </tr>
        `;
    }
    
    if (node.completed_at) {
        html += `
                <tr>
                    <th>Completed:</th>
                    <td>${node.completed_at}</td>
                </tr>
        `;
    }
    
    if (node.duration) {
        html += `
                <tr>
                    <th>Duration:</th>
                    <td>${node.duration.toFixed(2)}s</td>
                </tr>
        `;
    }
    
    if (node.celery_task_id) {
        html += `
                <tr>
                    <th>Celery Task ID:</th>
                    <td><code>${node.celery_task_id}</code></td>
                </tr>
        `;
    }
    
    html += `
            </table>
        </div>
    `;
    
    // Console/Terminal Log
    html += `
        <div class="mb-4">
            <h6 class="border-bottom pb-2">
                <i class="fas fa-terminal text-primary mr-2"></i>Execution Log
                ${(node.status === 'running' || node.status === 'pending') ? '<span class="badge badge-info badge-sm ml-2"><i class="fas fa-sync-alt fa-spin"></i> Live</span>' : ''}
            </h6>
            <div class="terminal-output" id="node-logs-container" style="max-height: 400px;">
    `;
    
    // Display node logs if available
    if (node.logs && node.logs.length > 0) {
        node.logs.forEach(log => {
            const logTime = new Date(log.timestamp).toLocaleTimeString();
            let logClass = 'terminal-info';
            let logIcon = '‚ÑπÔ∏è';
            
            if (log.level === 'ERROR') {
                logClass = 'terminal-error';
                logIcon = '‚ùå';
            } else if (log.level === 'WARNING') {
                logClass = 'terminal-warning';
                logIcon = '‚ö†Ô∏è';
            } else if (log.level === 'DEBUG') {
                logClass = 'terminal-debug';
                logIcon = 'üîç';
            } else {
                logIcon = '‚úì';
            }
            
            html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${logTime}]</span>
                    <span class="terminal-prompt">${logIcon}</span>
                    <span class="${logClass}">${escapeHtml(log.message)}</span>
                </div>
            `;
            
            // Show context data if available
            if (log.context && Object.keys(log.context).length > 0) {
                html += `
                    <div class="terminal-line ml-4">
                        <span class="terminal-debug" style="font-size: 0.9em;">${escapeHtml(JSON.stringify(log.context, null, 2))}</span>
                    </div>
                `;
            }
        });
    } else if (node.error_message || node.error_traceback) {
    } else if (node.error_message || node.error_traceback) {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.started_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-error">Error occurred during execution</span>
                </div>
        `;
        
        if (node.error_message) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-error"><strong>Error Message:</strong> ${escapeHtml(node.error_message)}</span>
                </div>
            `;
        }
        
        if (node.error_traceback) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-error"><strong>Traceback:</strong></span>
                </div>
                <div class="terminal-line">
                    <pre class="terminal-error mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(node.error_traceback)}</pre>
                </div>
            `;
        }
    } else if (node.status === 'completed' && (!node.logs || node.logs.length === 0)) {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.completed_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-success">Node executed successfully</span>
                </div>
        `;
        
        if (node.output_data && Object.keys(node.output_data).length > 0) {
            html += `
                <div class="terminal-line">
                    <span class="terminal-info">Output data available (see below)</span>
                </div>
            `;
        }
    } else if (node.status === 'running') {
        html += `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date(node.started_at || Date.now()).toLocaleTimeString()}]</span>
                    <span class="terminal-prompt">${statusIcon}</span>
                    <span class="terminal-info">Node is currently executing...</span>
                </div>
        `;
    } else {
        html += `
                <div class="terminal-line">
                    <span class="terminal-info">Node has not started execution yet</span>
                </div>
        `;
    }
    
    html += `
            </div>
        </div>
    `;
    
    // Artifacts (show detailed analysis results)
    if (node.artifacts && Object.keys(node.artifacts).length > 0) {
        html += `
            <div class="mb-4">
                <h6 class="border-bottom pb-2">
                    <i class="fas fa-archive text-primary mr-2"></i>Analysis Results
                </h6>
        `;
        
        // Display 'result' artifact specially if it exists (full analysis)
        if (node.artifacts.result) {
            const result = node.artifacts.result;
            
            // Check if it's a code reproducibility analysis
            if (result.reproducibility_score !== undefined) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar mr-2"></i>
                                Code Reproducibility Analysis
                                <span class="badge badge-light text-primary float-right">
                                    Score: ${result.reproducibility_score}/10
                                </span>
                            </h6>
                        </div>
                        <div class="card-body">
                `;
                
                // Research Methodology (show type and what's applicable)
                if (result.research_methodology) {
                    const methodology = result.research_methodology;
                    const typeLabel = methodology.methodology_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    html += `
                        <div class="mb-3">
                            <h6><i class="fas fa-flask text-info mr-2"></i>Research Methodology</h6>
                            <p>
                                <strong>Type:</strong> <span class="badge badge-info">${typeLabel}</span><br>
                                ${methodology.methodology_notes ? `<small class="text-muted">${escapeHtml(methodology.methodology_notes)}</small>` : ''}
                            </p>
                        </div>
                    `;
                }
                
                // Overall Assessment
                if (result.overall_assessment) {
                    html += `
                        <div class="mb-3">
                            <h6><i class="fas fa-clipboard-check text-info mr-2"></i>Overall Assessment</h6>
                            <p>${escapeHtml(result.overall_assessment)}</p>
                        </div>
                    `;
                }
                
                // Score Breakdown
                if (result.score_breakdown && Object.keys(result.score_breakdown).length > 0) {
                    // Determine which components are applicable based on methodology
                    const methodology = result.research_methodology || {};
                    const requiresTraining = methodology.requires_training !== false; // default true
                    const requiresDatasets = methodology.requires_datasets !== false; // default true
                    const requiresSplits = methodology.requires_splits !== false; // default true
                    
                    // Define which components are N/A based on methodology
                    const componentApplicability = {
                        'code_completeness': true, // Always applicable
                        'dependencies': true, // Always applicable
                        'artifacts': requiresTraining || requiresDatasets, // N/A for theoretical papers
                        'dataset_splits': requiresSplits, // N/A for non-ML papers
                        'documentation': true // Always applicable
                    };
                    
                    html += `
                        <div class="mb-3">
                            <h6><i class="fas fa-tasks text-success mr-2"></i>Score Breakdown</h6>
                            <table class="table table-sm table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Component</th>
                                        <th style="width: 120px;">Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    for (const [key, value] of Object.entries(result.score_breakdown)) {
                        const isApplicable = componentApplicability[key] !== false;
                        const componentName = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        
                        if (!isApplicable) {
                            // Show N/A components with gray styling
                            html += `
                                <tr class="table-secondary">
                                    <td style="vertical-align: middle;">${componentName}</td>
                                    <td class="text-center" style="vertical-align: middle;">
                                        <span class="badge badge-secondary">N/A</span>
                                    </td>
                                </tr>
                            `;
                        } else {
                            // Show applicable components with progress bars
                            const percentage = (value / 10 * 100).toFixed(0);
                            const maxScore = key === 'code_completeness' ? (requiresTraining ? 3.0 : 2.5) : 
                                           key === 'artifacts' ? 2.5 :
                                           key === 'dataset_splits' ? 2.0 :
                                           key === 'dependencies' ? 1.0 : 2.0;
                            const relativePercentage = (value / maxScore * 100).toFixed(0);
                            const scoreText = `${value.toFixed(1)}/${maxScore.toFixed(1)}`;
                            
                            html += `
                                <tr>
                                    <td style="vertical-align: middle;">${componentName}</td>
                                    <td style="position: relative; vertical-align: middle; padding: 0.5rem;">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar ${value >= maxScore * 0.7 ? 'bg-success' : value >= maxScore * 0.4 ? 'bg-warning' : 'bg-danger'}" 
                                                 role="progressbar" 
                                                 style="width: ${Math.max(relativePercentage, 5)}%"
                                                 aria-valuenow="${value}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="${maxScore}">
                                            </div>
                                        </div>
                                        <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 500; font-family: monospace; color: ${relativePercentage > 50 ? '#fff' : '#333'};">
                                            ${scoreText}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }
                    }
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                // Recommendations
                if (result.recommendations && result.recommendations.length > 0) {
                    html += `
                        <div class="mb-3">
                            <h6><i class="fas fa-lightbulb text-warning mr-2"></i>Recommendations</h6>
                            <ul class="mb-0">
                    `;
                    result.recommendations.forEach(rec => {
                        html += `<li>${escapeHtml(rec)}</li>`;
                    });
                    html += `
                            </ul>
                        </div>
                    `;
                }
                
                // Code Availability
                if (result.code_availability) {
                    html += `
                        <div class="mb-3">
                            <h6><i class="fas fa-code text-primary mr-2"></i>Code Availability</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Code Available:</strong></td>
                                    <td>${result.code_availability.code_available ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-danger">No</span>'}</td>
                                </tr>
                    `;
                    if (result.code_availability.code_url) {
                        html += `
                                <tr>
                                    <td><strong>Repository URL:</strong></td>
                                    <td><a href="${escapeHtml(result.code_availability.code_url)}" target="_blank">${escapeHtml(result.code_availability.code_url)}</a></td>
                                </tr>
                        `;
                    }
                    if (result.code_availability.availability_notes) {
                        html += `
                                <tr>
                                    <td><strong>Notes:</strong></td>
                                    <td>${escapeHtml(result.code_availability.availability_notes)}</td>
                                </tr>
                        `;
                    }
                    html += `
                            </table>
                        </div>
                    `;
                }
                
                // Show full JSON in a collapsible section
                html += `
                            <div class="mt-3">
                                <a class="btn btn-sm btn-outline-secondary" data-toggle="collapse" href="#fullResultJson" role="button">
                                    <i class="fas fa-code mr-1"></i> View Full JSON
                                </a>
                                <div class="collapse mt-2" id="fullResultJson">
                                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(result, null, 2))}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (result.paper_type !== undefined) {
                // Paper type classification result
                // Normalize paper_type value
                const paperType = result.paper_type || 'unknown';
                
                // Display name mapping
                const typeDisplayNames = {
                    'method': 'method',
                    'dataset': 'dataset',
                    'both': 'Dataset&Method',
                    'theoretical': 'theoretical',
                    'unknown': 'unknown'
                };
                const displayName = typeDisplayNames[paperType] || paperType;
                
                const typeColors = {
                    'method': 'primary',
                    'dataset': 'success',
                    'both': 'warning',
                    'theoretical': 'info',
                    'unknown': 'secondary'
                };
                const badgeColor = typeColors[paperType] || 'secondary';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-tag mr-2"></i>
                                Paper Type Classification
                                <span class="badge badge-${badgeColor} float-right" style="font-size: 0.9rem;">
                                    ${escapeHtml(displayName).toUpperCase()}
                                </span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                            <p><strong>Reasoning:</strong> ${escapeHtml(result.reasoning)}</p>
                            ${result.key_evidence && result.key_evidence.length > 0 ? `
                                <h6>Key Evidence:</h6>
                                <ul>
                                    ${result.key_evidence.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
                                </ul>
                            ` : ''}
                            <div class="mt-3">
                                <a class="btn btn-sm btn-outline-secondary" data-toggle="collapse" href="#fullResultJson" role="button">
                                    <i class="fas fa-code mr-1"></i> View Full JSON
                                </a>
                                <div class="collapse mt-2" id="fullResultJson">
                                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(result, null, 2))}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Generic result artifact
                html += `
                    <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(result, null, 2))}</code></pre>
                `;
            }
        }
        
        // Show other artifacts
        for (const [name, artifact] of Object.entries(node.artifacts)) {
            if (name !== 'result' && name !== 'token_usage') {
                html += `
                    <div class="mb-2">
                        <h6 class="text-muted">${name}</h6>
                        <pre class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(artifact, null, 2))}</code></pre>
                    </div>
                `;
            }
        }
        
        html += `
            </div>
        `;
    }
    
    // Output Data (minimal technical data)
    if (node.output_data && Object.keys(node.output_data).length > 0) {
        html += `
            <div class="mb-3">
                <h6 class="border-bottom pb-2">
                    <i class="fas fa-database text-secondary mr-2"></i>Output Data (Technical)
                </h6>
                <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(node.output_data, null, 2))}</code></pre>
            </div>
        `;
    }
    
    // Input Data
    if (node.input_data && Object.keys(node.input_data).length > 0) {
        html += `
            <div class="mb-3">
                <h6 class="border-bottom pb-2">
                    <i class="fas fa-inbox text-primary mr-2"></i>Input Data
                </h6>
                <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>${escapeHtml(JSON.stringify(node.input_data, null, 2))}</code></pre>
            </div>
        `;
    }
    
    $('#node-details-content').html(html);
    
    // Auto-scroll to bottom of logs if node is running
    if (node.status === 'running' || node.status === 'pending') {
        const logsContainer = document.getElementById('node-logs-container');
        if (logsContainer) {
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Function to render/update the Mermaid diagram
function renderWorkflowDiagram(nodes) {
    if (Object.keys(nodes).length === 0) return;
    
    // Build Mermaid graph syntax
    let mermaidSyntax = 'graph LR\n';
    
    // Add nodes with styling based on status
    for (const [nodeId, nodeData] of Object.entries(nodes)) {
        let statusIcon = '';
        if (nodeData.status === 'completed') {
            statusIcon = '‚úì';
        } else if (nodeData.status === 'running') {
            statusIcon = '‚ü≥';
        } else if (nodeData.status === 'failed') {
            statusIcon = '‚úó';
        } else {
            statusIcon = '‚óã';
        }
        const label = `${statusIcon}  ${nodeData.display_name}`;
        mermaidSyntax += `    ${nodeId}["${label}"]:::${nodeData.status}\n`;
    }
    
    // Add edges
    edges.forEach(edge => {
        mermaidSyntax += `    ${edge.from} --> ${edge.to}\n`;
    });
    
    // Add click events
    for (const [nodeId] of Object.entries(nodes)) {
        mermaidSyntax += `    click ${nodeId} clickNode\n`;
    }
    
    // Clear and render
    const mermaidDiv = document.createElement('div');
    mermaidDiv.className = 'mermaid';
    mermaidDiv.textContent = mermaidSyntax;
    $('#workflow-mermaid').html(mermaidDiv);
    
    // Render with callback
    mermaid.init(undefined, mermaidDiv).then(() => {
        // Add SVG gradients
        const svg = $('#workflow-mermaid svg')[0];
        if (svg && !svg.querySelector('#gradient-completed')) {
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            
            // Completed gradient (green)
            const gradCompleted = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradCompleted.setAttribute('id', 'gradient-completed');
            gradCompleted.setAttribute('x1', '0%');
            gradCompleted.setAttribute('y1', '0%');
            gradCompleted.setAttribute('x2', '100%');
            gradCompleted.setAttribute('y2', '100%');
            gradCompleted.innerHTML = `
                <stop offset="0%" style="stop-color:#16a085;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#1abc9c;stop-opacity:1" />
            `;
            
            // Running gradient (blue)
            const gradRunning = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradRunning.setAttribute('id', 'gradient-running');
            gradRunning.setAttribute('x1', '0%');
            gradRunning.setAttribute('y1', '0%');
            gradRunning.setAttribute('x2', '100%');
            gradRunning.setAttribute('y2', '100%');
            gradRunning.innerHTML = `
                <stop offset="0%" style="stop-color:#2874a6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#3498db;stop-opacity:1" />
            `;
            
            // Failed gradient (red)
            const gradFailed = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradFailed.setAttribute('id', 'gradient-failed');
            gradFailed.setAttribute('x1', '0%');
            gradFailed.setAttribute('y1', '0%');
            gradFailed.setAttribute('x2', '100%');
            gradFailed.setAttribute('y2', '100%');
            gradFailed.innerHTML = `
                <stop offset="0%" style="stop-color:#c0392b;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#e74c3c;stop-opacity:1" />
            `;
            
            // Pending gradient (yellow/gold)
            const gradPending = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradPending.setAttribute('id', 'gradient-pending');
            gradPending.setAttribute('x1', '0%');
            gradPending.setAttribute('y1', '0%');
            gradPending.setAttribute('x2', '100%');
            gradPending.setAttribute('y2', '100%');
            gradPending.innerHTML = `
                <stop offset="0%" style="stop-color:#d4ac0d;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#f4d03f;stop-opacity:1" />
            `;
            
            defs.appendChild(gradCompleted);
            defs.appendChild(gradRunning);
            defs.appendChild(gradFailed);
            defs.appendChild(gradPending);
            
            svg.insertBefore(defs, svg.firstChild);
            
            // Round rectangle corners
            svg.querySelectorAll('.node rect').forEach(rect => {
                rect.setAttribute('rx', '8');
                rect.setAttribute('ry', '8');
            });
        }
    }).catch(err => {
        console.error('Mermaid rendering error:', err);
    });
}

// Function to poll for workflow status updates
function pollWorkflowStatus() {
    if (!workflowRunId) return;
    
    $.ajax({
        url: '/workflow/status/' + workflowRunId + '/',
        method: 'GET',
        success: function(data) {
            console.log('Workflow status update:', data);
            
            // Check if nodes have changed
            let hasChanges = false;
            for (const [nodeId, nodeData] of Object.entries(data.nodes)) {
                if (!nodesData[nodeId] || nodesData[nodeId].status !== nodeData.status) {
                    hasChanges = true;
                    break;
                }
            }
            
            // Update nodes and re-render if changes detected
            if (hasChanges) {
                console.log('Node status changes detected, re-rendering diagram');
                nodesData = data.nodes;
                renderWorkflowDiagram(nodesData);
            }
            
            // Stop polling if workflow is no longer running/pending
            if (data.status !== 'running' && data.status !== 'pending') {
                console.log('Workflow completed, stopping auto-update');
                stopPolling();
                
                // Reload page to update workflow run history and status badge
                setTimeout(function() {
                    location.reload();
                }, 2000);
            }
        },
        error: function(xhr, status, error) {
            console.error('Polling error:', error);
            // Don't stop polling on temporary errors
        }
    });
}

// Function to start polling
function startPolling() {
    if (pollingInterval) return; // Already polling
    
    console.log('Starting auto-update polling');
    pollingInterval = setInterval(pollWorkflowStatus, 3000); // Poll every 3 seconds
}

// Function to stop polling
function stopPolling() {
    if (pollingInterval) {
        console.log('Stopping auto-update polling');
        clearInterval(pollingInterval);
        pollingInterval = null;
        $('#auto-update-indicator').fadeOut();
    }
}

// Start polling if workflow is running or pending
$(document).ready(function() {
    if (workflowStatus === 'running' || workflowStatus === 'pending') {
        startPolling();
    }
});

// Function to rerun workflow
function rerunWorkflow(paperId) {
    // Store paper ID for later use
    $('#rerunWorkflowModal').data('paperId', paperId);
    
    // Load available workflows
    loadAvailableWorkflows(paperId);
    
    // Show confirmation modal
    $('#rerunWorkflowModal').modal('show');
}

// Function to load available workflows
function loadAvailableWorkflows(paperId) {
    const select = $('#workflow-type-select');
    select.html('<option value="" disabled selected>Loading workflows...</option>');
    
    $.ajax({
        url: `/paper/${paperId}/rerun-workflow/`,
        method: 'GET',
        success: function(response) {
            select.empty();
            
            // Add workflow options
            if (response.workflows) {
                Object.keys(response.workflows).forEach(function(key) {
                    const workflow = response.workflows[key];
                    const option = $('<option></option>')
                        .attr('value', key)
                        .text(workflow.name);
                    
                    // Select default workflow
                    if (workflow.default || key === response.default_workflow) {
                        option.attr('selected', 'selected');
                        $('#workflow-description').text(workflow.name);
                    }
                    
                    select.append(option);
                });
            }
            
            // Enable the confirm button
            $('#confirm-rerun-btn').prop('disabled', false);
        },
        error: function(xhr) {
            console.error('Failed to load workflows:', xhr);
            select.html('<option value="" disabled selected>Error loading workflows</option>');
            $('#confirm-rerun-btn').prop('disabled', true);
        }
    });
}

// Update workflow description when selection changes
$('#workflow-type-select').on('change', function() {
    const selectedOption = $(this).find('option:selected');
    $('#workflow-description').text(selectedOption.text());
});

// Handle confirmation button click
$('#confirm-rerun-btn').on('click', function() {
    const paperId = $('#rerunWorkflowModal').data('paperId');
    const workflowType = $('#workflow-type-select').val();
    const btn = $(this);
    const originalHtml = btn.html();
    
    // Validate workflow selection
    if (!workflowType) {
        alert('Please select a workflow to run');
        return;
    }
    
    // Get force reprocess flag
    const forceReprocess = $('#force-reprocess-checkbox').is(':checked');
    
    // Disable button and show loading state
    btn.prop('disabled', true);
    btn.html('<i class="fas fa-spinner fa-spin mr-1"></i> Starting...');
    
    // Disable cancel button
    $('#rerunWorkflowModal .btn-secondary').prop('disabled', true);
    
    // Get CSRF token
    const csrfToken = $('input[name="csrfmiddlewaretoken"]').val() || 
                      document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                      getCookie('csrftoken');
    
    // Make AJAX request with selected workflow type
    $.ajax({
        url: `/paper/${paperId}/rerun-workflow/`,
        method: 'POST',
        data: {
            'workflow_type': workflowType,
            'force_reprocess': forceReprocess
        },
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            if (response.success) {
                // Workflow started successfully - reload immediately to show running workflow
                $('#rerunWorkflowModal').modal('hide');
                location.reload();
            } else {
                // Show error
                $('#rerunWorkflowModal .modal-body').html(`
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Error:</strong> ${response.error || 'Unknown error occurred'}
                    </div>
                `);
                btn.prop('disabled', false);
                btn.html(originalHtml);
                $('#rerunWorkflowModal .btn-secondary').prop('disabled', false);
            }
        },
        error: function(xhr) {
            console.error('Workflow rerun error:', xhr);
            let errorMsg = 'Failed to start workflow';
            let isAlreadyRunning = false;
            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || errorMsg;
                if (response.status && (response.status === 'running' || response.status === 'pending')) {
                    isAlreadyRunning = true;
                }
            } catch(e) {
                errorMsg += ': ' + xhr.statusText;
            }
            
            // Show error in modal with helpful instructions
            let errorHtml = `
                <div class="alert alert-${isAlreadyRunning ? 'warning' : 'danger'} mb-0">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error:</strong> ${errorMsg}
            `;
            
            if (isAlreadyRunning) {
                errorHtml += `
                    <hr class="mt-2 mb-2">
                    <small>
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>What to do:</strong>
                        <ul class="mb-0 mt-1" style="padding-left: 20px;">
                            <li>Wait for the current workflow to complete (check the DAG diagram)</li>
                            <li>Or wait 5 minutes to force rerun if the workflow appears stuck</li>
                            <li>Refresh the page to see the current status</li>
                        </ul>
                    </small>
                `;
            }
            
            errorHtml += `</div>`;
            
            $('#rerunWorkflowModal .modal-body').html(errorHtml);
            btn.prop('disabled', false);
            btn.html(originalHtml);
            $('#rerunWorkflowModal .btn-secondary').prop('disabled', false);
        }
    });
});

// Handle rerun single node confirmation
$('#confirm-rerun-node-btn').on('click', function() {
    console.log('Rerun node confirmation clicked, currentNodeId:', currentNodeId);
    const btn = $(this);
    const originalHtml = btn.html();
    
    // Disable button and show loading state
    btn.prop('disabled', true);
    btn.html('<i class="fas fa-spinner fa-spin mr-1"></i> Processing...');
    
    // Disable cancel button
    $('#rerunNodeModal .btn-secondary').prop('disabled', true);
    
    const csrfToken = getCookie('csrftoken');
    
    console.log('Making AJAX request to:', `/workflow/node/${currentNodeId}/rerun/`);
    
    $.ajax({
        url: `/workflow/node/${currentNodeId}/rerun/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            console.log('Rerun node response:', response);
            if (response.success) {
                // Close modals and reload page to show updated workflow
                $('#rerunNodeModal').modal('hide');
                $('#nodeDetailsModal').modal('hide');
                location.reload();
            } else {
                // Show error
                $('#rerunNodeModal .modal-body').html(`
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Error:</strong> ${response.error || 'Failed to rerun node'}
                    </div>
                `);
                btn.prop('disabled', false);
                btn.html(originalHtml);
                $('#rerunNodeModal .btn-secondary').prop('disabled', false);
            }
        },
        error: function(xhr) {
            console.error('Rerun node error:', xhr);
            let errorMsg = 'Failed to rerun node';
            let isAlreadyRunning = false;
            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || errorMsg;
                if (response.status && (response.status === 'running' || response.status === 'pending')) {
                    isAlreadyRunning = true;
                }
            } catch(e) {
                errorMsg += ': ' + xhr.statusText;
            }
            
            // Show error in modal with helpful instructions
            let errorHtml = `
                <div class="alert alert-${isAlreadyRunning ? 'warning' : 'danger'} mb-0">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error:</strong> ${errorMsg}
            `;
            
            if (isAlreadyRunning) {
                errorHtml += `
                    <hr class="mt-2 mb-2">
                    <small>
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>What to do:</strong>
                        <ul class="mb-0 mt-1" style="padding-left: 20px;">
                            <li>Wait for the current execution to complete (check the Live updates)</li>
                            <li>Or wait 2 minutes to force rerun if the node appears stuck</li>
                            <li>Refresh the page to see the current status</li>
                        </ul>
                    </small>
                `;
            }
            
            errorHtml += `</div>`;
            
            $('#rerunNodeModal .modal-body').html(errorHtml);
            btn.prop('disabled', false);
            btn.html(originalHtml);
            $('#rerunNodeModal .btn-secondary').prop('disabled', false);
        }
    });
});

// Handle rerun from node confirmation
$('#confirm-rerun-from-node-btn').on('click', function() {
    console.log('Rerun from node confirmation clicked, currentNodeId:', currentNodeId);
    const btn = $(this);
    const originalHtml = btn.html();
    
    // Disable button and show loading state
    btn.prop('disabled', true);
    btn.html('<i class="fas fa-spinner fa-spin mr-1"></i> Starting...');
    
    // Disable cancel button
    $('#rerunFromNodeModal .btn-secondary').prop('disabled', true);
    
    const csrfToken = getCookie('csrftoken');
    
    console.log('Making AJAX request to:', `/workflow/node/${currentNodeId}/rerun-from/`);
    
    $.ajax({
        url: `/workflow/node/${currentNodeId}/rerun-from/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            console.log('Rerun from node response:', response);
            if (response.success) {
                // Close modals and reload page to show new workflow run
                $('#rerunFromNodeModal').modal('hide');
                $('#nodeDetailsModal').modal('hide');
                location.reload();
            } else {
                // Show error
                $('#rerunFromNodeModal .modal-body').html(`
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Error:</strong> ${response.error || 'Failed to rerun from node'}
                    </div>
                `);
                btn.prop('disabled', false);
                btn.html(originalHtml);
                $('#rerunFromNodeModal .btn-secondary').prop('disabled', false);
            }
        },
        error: function(xhr) {
            console.error('Rerun from node error:', xhr);
            let errorMsg = 'Failed to rerun from node';
            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || errorMsg;
            } catch(e) {
                errorMsg += ': ' + xhr.statusText;
            }
            
            // Show error in modal
            $('#rerunFromNodeModal .modal-body').html(`
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error:</strong> ${errorMsg}
                </div>
            `);
            btn.prop('disabled', false);
            btn.html(originalHtml);
            $('#rerunFromNodeModal .btn-secondary').prop('disabled', false);
        }
    });
});

// Function to rerun single node
function rerunNode() {
    console.log('rerunNode called, currentNodeId:', currentNodeId);
    if (!currentNodeId) {
        alert('No node selected');
        return;
    }
    
    // Show confirmation modal
    $('#rerunNodeModal').modal('show');
}

// Function to rerun workflow from this node
function rerunFromNode() {
    console.log('rerunFromNode called, currentNodeId:', currentNodeId);
    if (!currentNodeId) {
        alert('No node selected');
        return;
    }
    
    // Show confirmation modal
    $('#rerunFromNodeModal').modal('show');
}

// Helper function to get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

